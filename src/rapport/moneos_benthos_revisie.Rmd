---
title: "Revisie van het MONEOS macrozoöbenthos meetnet"
author: 
  - firstname: Hans
    name: "Van Calster"
    email: hans.vancalster@inbo.be
    orcid: 0000-0001-8595-8426
  - firstname: Raïsa
    name: Carmen
    email: raisa.carmen@inbo.be
    orcid: 0000-0003-1025-8702
style: INBO
lang: nl
lot: TRUE
lof: TRUE

#colofon
shortauthor: "Van Calster, H. & Carmen, R."
corresponding: hans.vancalster@inbo.be
reviewer:
  - firstname: Frank
    name: "Van de Meutter"
    email: frank.vandemeutter@inbo.be
    orcid: 0000-0002-9850-1860
  - firstname: Joost
    name: "Vanoverbeke"
    email: joost.vanoverbeke@inbo.be
    orcid: 0000-0002-3893-9529
year: 2021
cover_photo:
cover_description:
doi:
reportnr:
depotnr:
embargo:

bibliography: [moneos.bib]
link-citations: TRUE
site: bookdown::bookdown_site

# HTML report specific options. See ?INBOmd::gitbook() for full list and more details.
github-repo: inbo/moneos-benthos-revisie

output:
  INBOmd::gitbook: default
  INBOmd::pdf_report:
    includes:
      in_header: 'gt_packages.sty'
---

# Voorwoord {.unnumbered}

# Samenvatting {.unnumbered}

De tekst voor de verplichte samenvatting.
Hou het [Heerlijk Helder](https://overheid.vlaanderen.be/communicatie/heerlijk-helder).

# Aanbevelingen voor beheer en/of beleid {.unnumbered}

Verplicht wanneer relevant.

\benglish

# English abstract {.unnumbered}

Insert a translation of the summary here.
\eenglish

```{r renv-restore, eval = FALSE, echo=FALSE}
renv::restore()
cmdstanr::install_cmdstan(version = "v2.28.0")
```

```{r setup, include = FALSE}
library(knitr)
opts_chunk$set(
  echo = FALSE,
  eval = TRUE,
  cache = FALSE,
  warning = TRUE,
  error = FALSE,
  message = TRUE
)
library(tidyverse)
library(INBOtheme)
if (interactive()) {
  theme_set(theme_inbo(base_size = 10))
} else {
  switch(
    opts_knit$get("rmarkdown.pandoc.to"),
    html = {
      opts_chunk$set(dev = "png", dpi = 72)
      theme_set(theme_inbo(base_size = 12))
    },
    latex = {
      opts_chunk$set(dev = "cairo_pdf", dpi = 300)
      theme_set(theme_inbo(base_size = 9))
      update_geom_defaults("point", list(size = 1.5))
    },
    epub3 = {
      opts_chunk$set(dev = "png", dpi = 300)
      theme_set(theme_inbo(base_size = 12))
    }
  )
}
library(rprojroot)
source(find_root_file("src/utils/utility_functions.R",
                      criterion = is_git_root))
gdrive_data_path <- get_map_data_moneos()
gdrive_gdb_path <- file.path(gdrive_data_path, "GIS/MONEOS.gdb")

library(sf)
library(survey)
library(srvyr)
library(git2rdata)
library(mapview)
mapviewOptions(platform = "leaflet", fgb = FALSE)
library(brms)
library(tidybayes)
library(glmmTMB)
library(gt)
library(terra)
library(spatstat)
# function to add caption when gt table is output to pdf
as_latex_with_caption <- function(gt, tabref) {
  gt <- as_latex(gt)
  caption <- paste0(
    "\\caption{\\label{tab:", tabref, "}(ref:", tabref, ")}\\\\")
  latex <- strsplit(gt[1], split = "\n")[[1]]
  latex <- c(latex[1], caption, latex[-1])
  latex <- paste(latex, collapse = "\n")
  gt[1] <- latex
  return(gt)
}
```

```{r packages, eval=FALSE}
knitr::write_bib(file = find_root_file(
  "src/rapport/packages.bib",
  criterion = is_git_root
))
```

<!--chapter:end:index.Rmd-->

---
bibliography: moneos.bib
---

# Inleiding

Het MONEOS langetermijn monitoring- en onderzoeksprogramma heeft als belangrijkste doelstelling om grensoverschrijdende samenwerking over het beheer en beleid rond het Zeeschelde estuarium en zijn getijderivieren te ondersteunen.
Dit programma staat beschreven in @meire2008.
Het betreft een breed programma waar zowel fysisch-chemische als biologische variabelen worden ingezameld en onderzocht sinds 2008.
Binnen de biologische variabelen kijkt men onder meer naar het macrozoöbenthos (MZB) [@speybroeck2014].
Deze gegevens worden niet alleen gebruikt voor de beoordeling van de draagkracht en het ecologisch functioneren van het Zeeschelde-estuarium, maar ook voor beoordelingen voor de Europese Kaderrichtlijn Water.
Jaarlijks publiceert INBO een datarapport waarin een overzicht staat van de ruwe gegevens, die door INBO worden ingezameld in het kader van MONEOS [e.g. @ryckegem2020].

Sinds 2008, wordt jaarlijks een monitoring gedaan van MZB in de Zeeschelde (dit is de SPATIAL campagne).
In @speybroeck2014 worden ook de historische MZB gegevens besproken die tussen 1999 en 2008 ingezameld werden.
De jaarlijkse campagne houdt rekening met grote verschillen in fysiotopen langsheen het waterlichaam en moet een representatief beeld geven voor de toestand in een bepaald jaar.
Elk jaar worden nieuwe locaties getrokken volgens een gestratificeerde, random steekproef.
Het doel van deze campagne is om de (intertidale) systeembiomassa van MZB in zacht substraat in te schatten.
Deze systeembiomassa is een maat voor de draagkracht van de Zeeschelde (ZS).
Er is een vast criterium voor evaluatie: 30 ton intertidale droge massa moet minstens aanwezig zijn over de hele schelde en er zijn ook enkele subcriteria voor een uniforme verdeling over de hele Zeeschelde.

Parallel met de SPATIAL campagne, loopt er sinds 2018 ook een campagne waarbij MZB bemonsterd wordt op vaste locaties die gelegen zijn langsheen raaien (transecten) loodrecht op de rivieras in de intertidale zone.
Deze vaste locaties langsheen raaien laten in principe beter toe om een antwoord te geven op vragen zoals "Welke effecten hebben sedimenthoogteveranderingen (door verdieping van de Schelde) op samenstelling en densiteit van MZB?".
Deze raaien zijn gericht gekozen in de ecologisch interessantste gebieden met een intakte slibplaat.
Deze wijziging in strategie vormt een terugkeer naar de manier van werken van vóór 2008, waar er ook met vaste raaien werd gewerkt [@speybroeck2014].

De gecombineerde inspanning om zowel MZB te bemonsteren in de SPATIAL campagne als de RAAIEN campagne is groot.
De vraag stelt zich dan ook of er een optimalisatie mogelijk is van de veldwerkcampagnes zonder dat hiervoor een te grote afbreuk wordt gedaan aan de invulling van de verschillende doelstellingen van deze campagnes.

In dit rapport behandelen we de volgende **vraagstellingen**:

-   Is het steekproefontwerp (steekproefgrootte, stratificatie, randomisatieprocedure) van de SPATIAL campagne voldoende om robuuste uitspraken te kunnen doen over de toestand van de systeembiomassa? De jaarlijks berekende schatting van de systeembiomassa wordt tot nu toe gerapporteerd zonder foutenmarge. Deze foutenmarge is echter nodig om statistisch onderbouwde uitspraken te kunnen doen over de draagkracht van de Zeeschelde (aftoetsing ten opzichte van drempelwaarde van 30 ton).
-   Is het mogelijk om de systeembiomassa in te schatten waarbij zo veel mogelijk gegevens afkomstig van vaste raaien worden gebruikt aangevuld met een beperkte SPATIAL campagne?
-   Voor het stratified random sample moeten veel ecologisch gezien oninteressante gebieden meegenomen worden, waar vogels nauwelijks of niet foerageren (MZB als voedselbron). Zijn deze gebieden dan nodig voor de berekening van de draagkracht van de rivier?

```{=html}
<!--
To do (frank/Joost) Alle achtergrondliteratuur samen zetten Data (google sheets) delen.
Berekening eindcijfer uitschrijven / script / ... Kaartmaterialen / shapefiles / rasters zijn op schaal van een vierkante meter.
-->
```

<!--chapter:end:01_inleiding.Rmd-->

---
bibliography: [moneos.bib]
---

# Materiaal en methoden

```{r benthos-afdw}
benthos <- read_vc(file = "benthos",
                   root = find_root_file("data",
                                         criterion = is_git_root))

# correctie van ecotoop van een punt dat duidelijk in subtidaal lag
benthos$ecotoop_werkelijk[
  benthos$staal == "DU18_23" & benthos$jaar == "2018"] <- "matig diep subtidaal"

benthos_afdw <- benthos %>%
  mutate(survey = ifelse(grepl("raai", .$campagne.y), "raai", "spatial")) %>%
  # enkele stalen met negatieve AFDW: op nul zetten
  # bij enkele stalen stonden Z-waarden (hoogte) in mm ipv m
  mutate(AFDW = ifelse(AFDW < 0, 0, AFDW),
         Z = ifelse(Z >= 20, Z / 1000, Z)) %>%
  group_by(survey, campagne.x, campagne.y, staal, staalcode, jaar, datum.x,
           datum.y, real_X, real_Y, Z, geomorf, ecotoop_werkelijk,
           ecotoop_gepland, SalZone, Vallei_deel, Omessegment, KRWzone) %>%
  summarise(tot_aantal = sum(aantal),
            tot_afdw = sum(AFDW),
            aantal_fractietaxa = n_distinct(soort, fractie),
           .groups = "drop")
```

```{r eval=FALSE}
# mogelijke fouten in de data:
benthos_afdw %>%
  filter(str_extract(campagne.x, "SP\\d{2}") !=
           str_extract(campagne.y, "SP\\d{2}")) %>%
  select(staal, survey, campagne.x, campagne.y, jaar, datum.x, datum.y)
# verschillend jaartal in campagne.x en campagne.y
# variabele jaar komt overeen met campagne.y en is conform datum.x en datum.y
# dus best variabelen jaar en survey gebruiken (niet campagne.x)

# staal waar real_X 0 is en metadata ontbreken
benthos_afdw %>%
  filter(real_X == 0)
# uit mail Frank: DG18_23 is een bestaand benthosstaal (zie benthosdata -niet
# weggevallen of verlegd dus) in matig diep subtidaal genomen.
```

```{r ecotoop, warning=FALSE}
layers <- st_layers(gdrive_gdb_path)

ecotoop <- read_sf(gdrive_gdb_path,
                   layer = layers$name[1]) %>%
  st_cast("MULTIPOLYGON") %>%
  mutate(ecotoop_werkelijk = recode(as.factor(Ecotoop),
                                    "breuksteen" = "hard substraat",
                                    "hard antropogeen" = "hard substraat",
                                    "hoog slik" = "hoge slikzone",
                                    "middelhoog slik" = "middelhoge slikzone",
                                    "laag slik" = "lage slikzone",
                                    "intertidaal" = "slik"),
         KRWzone = recode(as.factor(KRWzone),
                          "TijarmZwijnaarde" = "Tijarm-Zwijnaarde"),
         KRWzone = replace_na(KRWzone, "Getijdedijle en -zenne")
         )
```

```{r benthos-ecotoop}
benthos_afdw_ecotoop <- benthos_afdw %>%
  st_as_sf(coords = c("real_X", "real_Y"), crs = 31370) %>%
  st_join(ecotoop %>%
            select(-KRWzone, -SalZone),
          left = FALSE,
          suffix = c(".benthos", ".ecotoop"))
```

```{r eval=FALSE}
# probleemgevallen met verschillende ecosysteem_werkelijk
benthos_afdw_ecotoop %>%
  filter(as.character(ecotoop_werkelijk.benthos) !=
           as.character(ecotoop_werkelijk.ecotoop)) %>%
  st_drop_geometry() %>%
  select(jaar, staal, starts_with("ecotoop_werkelijk")) %>%
  gt()
```

## SPATIAL campagne

### Steekproefkader

De doelpopulatie betreft de subtidale geul (permanent ondergedoken) en de intertidale slikgebieden van de Zeeschelde en de getij-onderhevige delen van zijn zijrivieren (Rupel, Dijle, Zenne, Netes, Durme).
Het steekproefkader (ruimtelijke begrenzing), waarmee deze doelpopulatie benaderd wordt, wordt samengesteld aan de hand van 7 waterlichamen overeenkomend met waterlichamen afgebakend voor beoordeling in het kader van de Europese Kaderrichtlijn Water (KRW) [@speybroeck2014].

De biomassa doelstelling 30 ton wordt berekend op het intertidaal (slik) voor de Zeeschelde, Rupel en Durme.
Deze totaal doelstelling zal eveneens ook opgesplitst worden naar een minimum per zone:

-   Saliniteitsgradiënt: 14,2 ton

-   Oligohalien (+Rupel): 8,3 ton

-   Zoet Lange Verblijftijd (+Durme): 5 ton

-   Zoet Korte Verblijftijd: 2,5 ton

```{r biomassa-doelstellingen}
mzb_targets <- tibble(
  SalZone = c("Zoet korte verblijftijd",
              "Oligohalien",
              "Zoet lange verblijftijd",
              "Zone met sterke saliniteitsgradiënt"),
  doel = c(2.5, 8.3, 5, 14.2))
```

```{r zeeschelde-durme-rupel}
benthos_afdw_ecotoop %>%
  select(jaar, survey, staal, staalcode, tot_afdw, tot_aantal,
         aantal_fractietaxa,
         ecotoop_werkelijk.benthos,
         KRWzone,
         SalZone,
         Vallei_deel,
         Naam,
         stratum_opp_m2 = Shape_Area,
         Z) %>%
  filter(Naam %in% c("Zeeschelde", "Durme", "Rupel")) %>%
  group_by(jaar, KRWzone, ecotoop_werkelijk.benthos) %>%
  mutate(
    tidaal = ifelse(str_detect(ecotoop_werkelijk.benthos, "subtidaal"),
                    "subtidaal", "intertidaal"),
    SalZone = factor(SalZone)) %>%
  arrange(jaar, KRWzone, ecotoop_werkelijk.benthos, staal) %>%
  ungroup() -> benthos_afdw_zs_durme_rupel
```

```{r benthos-afdw-spatial}
#diameter = 4.5 cm
opp_per_staal_m2 <- pi * (4.5 / 100) ^ 2 / 4

benthos_afdw_zs_durme_rupel %>%
  filter(survey == "spatial",
         tidaal != "subtidaal") %>%
  group_by(jaar, KRWzone, ecotoop_werkelijk.benthos) %>%
  mutate(stratum_n = n(),
         stratum_weight = stratum_opp_m2 / (opp_per_staal_m2 * stratum_n)
         ) %>%
  arrange(jaar, KRWzone, ecotoop_werkelijk.benthos, staal) %>%
  ungroup() -> benthos_afdw_spatial
```

### Steekproefdesign

Het gaat om een stratified random design over waterlichamen en fysiotopen [@speybroeck2014].
De strata volgens waterlichamen komen overeen met een indeling in een saliniteitsgradiënt (dus zout naar zoet hoe verder weg van de monding van de Zeeschelde).
De stratificatie volgens fysiotoop reflecteert een indeling volgens een gradiënt loodrecht op de as van de rivieren (hoe hoger gelegen, hoe verder van de rivierbedding, hoe minder frequent overstroomt) (zie Figuur \@ref(fig:spatial-hoogtes)).

(ref:spatial-hoogtes) Voorstelling van de steekproef in functie van de hoogte en de verschillende saliniteitszones.

```{r spatial-hoogtes, fig.height=7.5, fig.cap="(ref:spatial-hoogtes)"}
benthos_afdw_spatial %>%
  mutate(staalcode = fct_reorder(staalcode, Z)) %>%
  ggplot() +
  geom_point(aes(x = Z, y = staalcode, colour = jaar,
                 shape = ecotoop_werkelijk.benthos),
             position = position_dodge(width = 0.5)) +
  labs(x = "Hoogte (m)") +
  facet_grid(vars(SalZone), scales = "free_y",
             labeller = label_wrap_gen(width = 20))
```

Tabel \@ref(tab:strata-krw) toont het eerste niveau van stratificatie volgens waterlichamen en hun link met de KRW-waterlichamen.
De Zeeschelde wordt jaarlijks bemonsterd.
De zijrivieren worden om de drie jaar bemonsterd.
Voor de vraagstelling waarbij we willen vergelijken hoe/of de benthosraaien inwisselbaar/vergelijkbaar zijn met de random punten (en wat de fout is op de schatting van systeembiomassa) zijn de zijrivieren niet van belang.
We zullen voor deze oefening de data daarom beperken tot die delen die wel jaarlijks bemonsterd worden.

(ref:strata-krw) Strata van eerste niveau en hun verband met de KRW-waterlichamen [@speybroeck2014].

```{r strata-krw}
strata_krw <- data.frame(
  `gebruikt stratum` = c("Zeeschelde IV",
                        "Zeeschelde III",
                        "Zeeschelde II",
                        "Zeeschelde I",
                        "Rupel",
                        "Durme",
                        "Netes",
                        "Dijle",
                        "Zenne"),
  `KRW-waterlichaam` = c("Zeeschelde IV",
                        "Zeeschelde III + Rupel",
                        "Zeeschelde II",
                        "Zeeschelde I",
                        "Zeescheld III + Rupel",
                        "Getijdedurme",
                        "Getijdenetes",
                        "Getijdedijle en -zenne",
                        "Getijdedijle en -zenne"),
  `saliniteitszone` = c("Mesohalien",
                        "Oligohalien",
                        "Zoet",
                        "Zoet",
                        "Oligohalien",
                        "Zoet",
                        "Zoet",
                        "Zoet",
                        "Zoet")
)

sktab <- strata_krw %>%
  gt(caption = "(ref:strata-krw)")

if (knitr::is_latex_output()) {
  as_latex_with_caption(sktab, "strata-krw")
} else {
  sktab
}
```

De ligging en oppervlakte van de fysiotopen verandert ieder jaar gedeeltelijk.
Deze kan afgeleid worden uit de gebiedsdekkende ecotoopkarteringen, die echter niet voor elk jaar beschikbaar is.
Tabel \@ref(tab:strata-fysiotopen) toont de indeling volgens fysiotopen (tweede niveau van stratificatie).

(ref:strata-fysiotopen) Strata van tweede niveau - fysiotopentypologie (Van Braeckel et al. 2006)

```{r strata-fysiotopen}
strata_fysiotopen <- data.frame(
      getijdenzone = c("intertidaal",
                       "intertidaal", "intertidaal", "subtidaal", "subtidaal",
                       "subtidaal"),
         Fysiotoop = c("hoog intertidaal",
                       "midden intertidaal", "laag intertidaal",
                       "ondiep subtidaal",
                       "matig diep subtidaal", "diep subtidaal"),
         definitie = c("0-25% overspoelingsduur",
                       "25-75% overspoelingsduur",
                       "75% overspoelingsduur - GLWS",
                       "0-2m onder GLWS", "2-5m onder GLWS", ">5m onder GLWS")
)

sftab <- strata_fysiotopen %>%
  gt(caption = "(ref:strata-fysiotopen)")

if (knitr::is_latex_output()) {
  as_latex_with_caption(sftab, "strata-fysiotopen")
} else {
  sftab
}
```

Voor elke combinatie waterlichaam x fysiotoop worden jaarlijks random staalnamelocaties vastgelegd.
In de meeste gevallen zijn dit 5 locaties per combinatie.
Voor het grootste areaal, Zeeschelde IV, wordt dit aantal opgetrokken naar 10 locaties per fysiotoop.
Voor de kleinste arealen, Dijle en Zenne, komt men toe met respectievelijk 3 en 2 locaties per fysiotoop.
Dit komt neer op 150 locaties die jaarlijks bemonsterd worden en 115 locaties driejaarlijks.
Dit is het theoretisch vooropgestelde aantal locaties volgens @speybroeck2014.
In de praktijk zien we dat er een iets hoger aantal locaties bemonsterd worden (Tabel \@ref(tab:spatial-steekproefgrootte)).
Dit komt doordat het MZB (biomassa/densiteit) in tijarmen sterk afwijkt van in de Zeeschelde zelf.
Dat wordt apart bemonsterd en gaat mogelijk leiden tot definitie van apart type fysiotoop.

(ref:spatial-steekproefgrootte) Gerealiseerde steekproefgroottes per stratumcombinatie op basis van enkel de spatial survey gegevens.

```{r spatial-steekproefgrootte, message = FALSE}
tab <- benthos_afdw_zs_durme_rupel %>%
  st_drop_geometry() %>%
  filter(survey == "spatial") %>%
  group_by(jaar, tidaal, KRWzone, ecotoop_werkelijk.benthos) %>%
  summarize(stratum_n = n(), .groups = "drop") %>%
  rename(zone = tidaal) %>%
  group_by(jaar, zone) %>%
  gt(caption = "(ref:spatial-steekproefgrootte)") %>%
  summary_rows(groups = TRUE,
               columns = stratum_n,
               fns = list(totaal = "sum"))

if (knitr::is_latex_output()) {
  as_latex_with_caption(tab, "spatial-steekproefgrootte")
} else {
  tab
}
```

Merk op dat de subtidale locaties niet nodig zijn voor de berekening waarbij een vergelijking nodig is met de streefwaarde van 30 ton biomassa.
Het gaat om iets minder dan de helft van het aantal locaties de spatial surveys (tabel \@ref(tab:spatial-steekproefgrootte)).

Alle stalen worden genomen tussen de eerste week van september en de eerste week van oktober.
In principe kan, als alles goed gaat, de staalname op 2-3 weken tijd uitgevoerd worden.
Er zijn geen replica's binnen eenzelfde locatie.

### Bemonsteringsprotocol

Voor de gedetailleerde beschrijving van het staalnameprotocol verwijzen we naar @speybroeck2014 (sectie 2.4.2).
We beperken ons hier tot enkel die elementen die van belang kunnen zijn voor onze vraagstellingen.
Er worden twee types stalen genomen, enkel het basisstaal is voor dit rapport van belang.

Zowel in het subtidaal als het intertidaal neemt men een steekbuisstaal met diameter van 4,5 cm tot 15 cm diepte, behalve in Zeeschelde IV tot 30 cm diep.
De bemonsterde oppervlakte en volume (bij 15 cm diepte) per locatie bedraagt dus respectievelijk: `r round(pi*4.5^2/4)` cm² en `r round(pi*4.5^2/4*15/1000,2)` liter (x2 bij 30 cm diepte).

### Procedure berekening van analysevariabelen

De stalen worden gefixeerd (doodt de aanwezige organismen) en pas daarna nat gezeefd over maaswijdtes van 0,5 en 1 mm.
Op de fractie \< 0,5 mm heeft men dus geen zicht, maar dit leidt slechts tot een beperkte onderschatting van de biomassa van 7,7% (+/- 2,7% standaardfout) volgens @speybroeck2014.

Alle individuen worden gedetermineerd tot op het laagste taxonomische niveau, behalve de oligochaeten die als één taxon worden beschouwd (om de drie jaar is er wel een apart staal waarop oligochaeten worden gedetermineerd).

De totale biomassa van een soort wordt per stratum bepaald en wordt berekend als het verschil tussen het drooggewicht (gewicht na drogen) en het asgewicht (gewicht na verassing).

De gegevens laten ook toe om allerlei verschillende soortdiversiteitsmaten te berekenen of soortsaccumulatiecurves te bepalen (verwacht aantal soorten in functie van gecumuleerd aantal stalen of aantal individuen).

### Belangrijkste kostenposten

```{=html}
<!--
Er zijn 3 mensen bijna fulltime mee bezig en uiteindelijk komt er maar 1 getal uit terwijl er eigenlijk veel meer data is.
-->
```
Omvang van het veldwerk:

-   staalname in intertidaal voor de raai- en de spatial campagne
-   staalname in subtidaal voor de spatial campagne

Omvang van het geassocieerde labowerk:

-   zeven van de stalen
-   uitsorteren van de stalen
-   determineren van de soorten
-   bepalen drooggewicht per soort per stratum
-   bepalen asgewicht per soort per stratum

Tabel \@ref(tab:tijdsinschatting) geeft een overzicht hiervan.

(ref:tijdsinschatting) Ruwe schatting van de tijdsverdeling voor het veldwerk en het labowerk in één jaar.

```{r tijdsinschatting, message=FALSE}
werklast <- read_csv(file = find_root_file("data/tijdinschatting.csv",
                                           criterion = is_git_root))

tab <- werklast %>%
  select(taakgroep, taak, tidaal, campagne, aantal_stalen,
         `totaal aantal uren gelogd` = tot_uren_gelogd) %>%
  group_by(taakgroep) %>%
  gt(caption = "(ref:tijdsinschatting)")

if (knitr::is_latex_output()) {
  as_latex_with_caption(tab, "tijdsinschatting")
} else {
  tab
}
```

```{r kosten}
kosten <- werklast %>%
  mutate(
    aantal_stalen = ifelse(is.na(aantal_stalen),
                           max(aantal_stalen, na.rm = TRUE),
                           aantal_stalen),
    uren_per_staal_reistijd = uren_per_staal_incl_reistijd -
      uren_per_staal_excl_reistijd,
    uren_per_staal_gelogd = tot_uren_gelogd / aantal_stalen,
    uren_per_staal_excl_reistijd = uren_per_staal_excl_reistijd /
      uren_per_staal_incl_reistijd * uren_per_staal_gelogd,
    uren_per_staal_reistijd = uren_per_staal_reistijd /
      uren_per_staal_incl_reistijd * uren_per_staal_gelogd) %>%
  select(taakgroep, taak, tidaal, campagne, starts_with("uren_per_staal"),
         -uren_per_staal_incl_reistijd)

kosten_veldwerk <- kosten %>%
  filter(taakgroep == "veldwerk") %>%
  select(-uren_per_staal_gelogd, -taak) %>%
  pivot_longer(cols = starts_with("uren"),
               names_to = "taak",
               values_to = "uren_per_staal_gelogd"
              ) %>%
  mutate(taak = ifelse(taak == "uren_per_staal_reistijd",
                             "reistijd",
                             "staalname")) %>%
  rename(kostenpost = taak) %>%
  mutate(kostenallocatie = ifelse(kostenpost == "reistijd",
                                  "selectiekost",
                                  "bemonsteringskost"),
         taakgroep = paste(taakgroep, campagne, sep = "_"),
         kostenpost = paste(kostenpost, tidaal, sep = "_")) %>%
  select(-campagne, -tidaal)

kosten_niet_veldwerk <- kosten %>%
  filter(taakgroep != "veldwerk") %>%
  select(taakgroep, taak, uren_per_staal_gelogd) %>%
  rename(kostenpost = taak) %>%
  mutate(kostenallocatie = c("selectiekost", rep("bemonsteringskost", 5)))
  
kosten <- bind_rows(kosten_veldwerk, kosten_niet_veldwerk) %>%
  relocate(kostenallocatie)
```

## Raaien

Sinds 2018 werden vaste raaien jaarlijks bemonsterd (170 punten), bovenop de 228 random stalen voor jaarlijkse rapportage.
Het gaat om 35 raaien (transecten) in de intertidale zone (dus niet in het subtidaal).
Dus gemiddeld worden er `r round(170/35)` locaties per raai bemonsterd.

```{r benthos-afdw-raai}
benthos_afdw_zs_durme_rupel %>%
  filter(survey == "raai",
         tidaal != "subtidaal") %>%
  group_by(jaar, KRWzone, ecotoop_werkelijk.benthos) %>%
  mutate(stratum_n = n(),
         stratum_weight = stratum_opp_m2 / (opp_per_staal_m2 * stratum_n)
         ) %>%
  arrange(jaar, KRWzone, ecotoop_werkelijk.benthos, staal) %>%
  ungroup() -> benthos_afdw_raai
```

De ligging van de raaien is gekozen in functie van het ecologisch belang en dekking van het systeem.
Ze zijn voornamelijk gelegd in de ecologisch interessantste gebieden met een intakte slibplaat (veel delen van de Schelde zijn verstevigd met breuksteen, bv ongeveer volledig westerschelde IV, wat een veel minder geschikt substraat is voor MZB).
Raaien zijn gebruikt om beter ecologische relaties te kunnen onderzoeken.
Ze zijn een betere basis voor onderzoek dan random punten die niet herbezocht worden.

(ref:raai-steekproefgrootte) Gerealiseerde steekproefgroottes per stratumcombinatie op basis van enkel de raaigegevens.

```{r raai-steekproefgrootte}
tab <- benthos_afdw_raai %>%
  st_drop_geometry() %>%
  group_by(jaar, ecotoop_werkelijk.benthos, KRWzone, SalZone, stratum_n) %>%
  summarize(n_raaien = n_distinct(staalcode),
            .groups = "drop_last") %>%
  rename(n_locaties = stratum_n) %>%
  group_by(jaar) %>%
  gt(caption = "(ref:raai-steekproefgrootte)") %>%
  summary_rows(
    groups = TRUE,
    columns = c(n_locaties, n_raaien),
    fns = list(total = "sum")
    )

if (knitr::is_latex_output()) {
  as_latex_with_caption(tab, "raai-steekproefgrootte")
} else {
  tab
}
```

De ligging van de locaties langsheen de raaien is volgens een hoogtegradiënt (loodrecht op de as van de rivier).
Dit heeft tot voordeel dat er tussen de locaties veel variatie kan verwacht worden terwijl tegelijk het veldwerk beperkt blijft doordat de locaties dicht bij elkaar liggen.
Dit soort van samplingstrategie wordt bediscussieerd in @gillison1985.
De auteurs geven aan dat deze strategie, waarbij transecten gericht volgens een omgevingsgradiënt worden gekozen, aanvaardbaar kan zijn op voorwaarde dat de totale steekproef aantoonbaar representatief is voor de gehele doelpopulatie én wanneer het doel van de survey is om zoveel mogelijk diversiteit (niet biomassa!) te vatten in de steekproef.
In figuur \@ref(fig:raai-hoogtes) zien we duidelijk dat de locaties langsheen de raaien liggen volgens een hoogtegradiënt.
Tussen de jaren blijven deze hoogtes meestal gelijk, maar soms zien we grote verschillen wellicht door de rivierwerking of effecten van baggerwerken.

(ref:raai-hoogtes) De hoogteligging van bemonsterde locaties langs elk van de raaien. De lijnen verbinden dezelfde locaties bemonsterd in verschillend jaren.

```{r raai-hoogtes, fig.height=7.5, fig.cap="(ref:raai-hoogtes)"}
benthos_afdw_raai %>%
  mutate(staalcode = fct_reorder(staalcode, Z)) %>%
  ggplot() +
  geom_point(aes(x = Z, y = staalcode, colour = jaar,
                 shape = ecotoop_werkelijk.benthos)) +
  geom_line(aes(x = Z, y = staalcode, group = staal)) +
  labs(x = "Hoogte (m)") +
  facet_grid(vars(SalZone), scales = "free_y",
             labeller = label_wrap_gen(width=20))
```

## Ligging van de locaties

(ref:leaflet-map) Ligging van de raai-locaties en de locaties van de gestratificeerde steekproef voor het jaar 2019.

```{r leaflet-map, out.width="100%", fig.cap="(ref:leaflet-map)", cache=TRUE}
krw_sf <- ecotoop %>%
  sf::st_simplify() %>%
  group_by(KRWzone) %>%
  summarize()

mapview(krw_sf) +
  benthos_afdw_zs_durme_rupel %>%
  filter(jaar == "2019") %>%
  mapview(zcol = c("survey"), burst = TRUE)
```

## Databeschikbaarheid

Momenteel zitten de meest recente gegevens in Google sheets.
Er wordt gewerkt aan een SQL databank (Scheldedatabank) waarin actuele en historische gegevens terecht komen.

## Gegevensverwerking

### Design-based inschatting biomassa

Voor de inschatting van de foutenmarge op de biomassa MZB, kunnen we gebruik maken van design-based formules voor de schatting van een totaal in een gestratificeerde steekproef.
Om het totaal in te schatten is het belangrijk dat we de juiste gewichten (inverse van inclusiekansen) gebruiken om de extrapolatie te doen van de totale biomassa geobserveerd in de steekproef naar de totale biomassa in het gehele systeem (de statistische populatie).
Stratificatie verhoogt de precisie van de schatters op voorwaarde dat de strata homogeen zijn.
Heterogene strata zullen daarentegen de precisie verlagen.
Homogene strata zijn strata waarbij de variantie binnen een stratum lager is dan de variantie tussen strata (en omgekeerd voor heterogene strata).
De design-based schatters voor het totaal en variantie op het totaal van een gestratificeerde steekproef zijn (voor het geval van één stratificatievariabele met $H$ strata):

$$\hat{y}_{hi} = \sum_{h=1}^H\frac{N_h}{n_h}\sum_{i=1}^{n_h}y_{hi}$$ en $$\hat{\sigma}^2_{\hat{y}} = \sum_{h=1}^H\hat{\sigma}^2_{\hat{y_h}} = \sum_{h=1}^H\frac{N^2_h}{n_h}\frac{1}{n_h-1}\sum_{i=1}^{n_h}(y_{hi}-\bar{y_h})^2$$

waarbij $N_h$ de populatiegrootte van stratum $h$ is, $n_h$ de steekproefgrootte van stratum $h$ en $y_{hi}$ is de waarde van de responsvariabele op locatie $i$ in stratum $h$.
Deze formules zijn de zogenaamde Horvitz-Thompson schatters voor een gestratificeerde steekproef [@horvitz1952].
We zullen in de resultaten hiernaar verwijzen als 'H-T'.

Op basis van deze formules kunnen vervolgens betrouwbaarheidsintervallen berekend worden.
Hierbij maken we gebruik van de normale distributie omdat de distributie van de schattingen, die je zou bekomen als je telkens opnieuw een steekproef zou trekken, normaal verdeeld is volgens de centrale limietstelling.
Hier wordt aan voldaan voor een aselecte gestratificeerde steekproef op voorwaarde dat de steekproefgrootte voldoende groot is en er geen invloedrijke datapunten zijn.

Merk op dat bij deze methode het mogelijk is dat het betrouwbaarheidsinterval negatieve waarden bevat terwijl biomassa uiteraard nooit negatief kan zijn.
Dit kan gebeuren wanneer de variabiliteit groot is en / of de steekproefgrootte klein.
We zullen in de resultaten deze negatieve ondergrenzen tonen, maar in de praktijk mogen deze gelijkgesteld worden aan 0.
We berekenen daarom ook een tweede design-based methode waarbij we vermijden dat de betrouwbaarheidsintervallen waarden kunnen bevatten die buiten het theoretische bereik van de beschouwde variabele liggen.
Hiervoor veronderstellen we dat de data een bepaalde statistische distributie volgt.
Voor continue waarden \>= 0 kunnen we een zogenaamde hurdle-gamma of hurdle-lognormale verdeling veronderstellen.
De hurdle is nodig voor waarden gelijk aan 0, omdat de gamma verdeling of lognormale verdeling enkel voor strikt positieve continue waarden gedefinieerd is.
Om deze verdelingen te fitten aan de data dient de 'likelihood' gemaximaliseerd te worden om puntschattingen te bekomen van de drie parameters (een parameter voor de kans op nul en twee parameters die het gemiddelde en de variantie van de Gamma of lognormale verdeling beschrijven).
Klassiek doet men dit met software voor veralgemeende lineaire regressiemodellen.
Om echter te garanderen dat de puntschattingen rekening houden met de steekproefgewichten (Engels: sampling weights; omgekeerde van de inclusiekansen), zijn er correcties nodig [@lumley2017; @lumley2004].
Een manier om gecorrigeerde, design-based standaardfouten te schatten is door het hurdle-gamma model vele malen opnieuw te fitten met telkens iets andere gewichten (replicated weights).
Het `survey` package heeft functies om deze set van gewichten te berekenen - het algoritme dat we hiervoor gebruikt hebben is het Jackknife algoritme voor gestratificeerde steekproeven.
We zullen in de resultaten daarom verwijzen naar deze methode als 'RW-J' (replicated weights - Jacknife methode).

### Multilevel regressie en poststratificatie

Een alternatieve analysemethode waarmee uitspraken kunnen gedaan worden over de statistische doelpopulatie op basis van een aselecte steekproef is Multilevel Regressie gevolgd door Poststratificatie (in de resultaten verwijzen we hiernaar als 'MRP')[@gelman2007; @gelman2007a; @si2020].

Bij deze aanpak, wordt eerst een multilevel regressie uitgevoerd waarbij de belangrijkste designvariabelen (strata, clustering, ...) als effecten aan het model worden toegevoegd.
Er wordt dus niet gewerkt met steekproefgewichten.
In een tweede poststratificatiestap worden daarna de parameterschattingen aangedikt door ze te wegen volgens de oppervlaktes van elk van de poststrata combinaties zodat uitspraken over de doelpopulatie gedaan kunnen worden.
Deze methode zou vooral interessant zijn voor uitspraken over kleine subdomeinen van de doelpopulatie.

Waar de design-based methodes absoluut een probabilistische steekproef vereisen, is dat bij MRP minder het geval.
Dat biedt perspectieven om de preferentieel ingezamelde data via de raaien met deze methode te analyseren of combinaties van beide surveys te exploreren.

Voor de MRP analyse veronderstellen we dat de data hurdle-gamma verdeeld zijn.
Als design-variabelen voegen we random intercepten toe voor de ecotopen en KRW zones en hun interactie.
We gebruiken in deze gevallen de modus (meest voorkomende/waarschijnlijke waarde) en een 95% (aaneengesloten) hoogste-densiteit interval om de posterior distributie samen te vatten.
De modus laat een vergelijking toe met de design-based schatters.

Voor de raaigegevens is het verleidelijk om ook de identiteit van de afzonderlijke raaien en de individuele locaties (genest in raaien) in de analyse te betrekken als random intercepten.
Door dit te doen kan er rekening gehouden worden met de gepaardheid van de individuele locaties en met het geclusterd zijn van de locaties binnen een bepaalde raai.
Wanneer we dit deden waren de schattingen echter erg onrealistisch en bekwamen we zeer brede betrouwbaarheidsintervallen.
Wellicht is het model met deze extra parameters te complex en worden sommige parameters zeer onnauwkeurig ingeschat.

### Allocatie van steekproefeenheden over strata

Voor een gestratificeerde steekproef kan volgende evenredigheid gebruikt worden voor een optimale allocatie van de totale steekproefgrootte over de verschillende strata:

$$n_h \propto \frac{N_h\sigma_h}{\sqrt{cost_h}}$$.

Dit suggereert dat een groter aandeel moet gaan naar grote strata (in oppervlakte), meer variabele strata en minder kostelijke strata.

### Afweging steekproefgrootte en bemonsteringsinspanning per locatie

Een eenvoudig denkmodel is een waarneming te beschrijven als een proces in drie stappen: eerst selecteren we een meetplaats, vervolgens bemonsteren we die en daarna verwerken we het staal.
Symbolisch:

$$\text{waarneming} \leftarrow \text{selectie} + \text{bemonstering} + \text{staalverwerking}$$

Dit model maakt duidelijk dat de totale waarnemingsfout ($\sigma^2_{TF}$) de som is van de selectiefout ($\sigma^2_{SF}$), de bemonsteringsfout ($\sigma^2_{BF}$) en een labofout ($\sigma^2_{LF}$), waarbij:

```{=latex}
\begin{align*}
\sigma^2_{SF} &= \frac{\sigma^2_P}{n}\\
\sigma^2_{BF} &= \frac{\sigma^2_B}{n}\\
\sigma^2_{LF} &= \frac{\sigma^2_L}{n}
\end{align*}
```

Hierbij hebben we een oneindige populatie verondersteld bij de formule voor de steekproeffout.
De steekproeffout neemt dus evenredig toe met de variabiliteit in de populatie ($\sigma^2_P$) en omgekeerd evenredig met de steekproefgrootte $n$.

De variabiliteit in de populatie is een intrinsiek gegeven: het kan niet verkleind of vergroot worden éénmaal we het kenmerk dat we willen meten hebben vastgelegd.
In ons geval is dit de biomassa MZB, $Y_i$ op een bepaalde locatie $i$.
De definitie van wat we als locatie beschouwen is hierbij van belang.
Het kenmerk zal van plaats tot plaats een andere waarde $Y_i$ hebben en deze intrinsieke (ruimtelijke) variabiliteit kunnen we berekenen via de formule voor een variantie:

$$
\frac{1}{N}\sum_{i=1}^N(Y_i - \mu)^2 \quad \textrm{met} \quad \mu = \frac{1}{N}\sum_{i=1}^NY_i
$$

De werkelijke biomassawaarde op een locatie $Y_i$ zal echter afwijken van wat we uiteindelijk meten: $Z_i$, maar het gemiddelde van de $Z_i$ op basis van $n$ aselect getrokken locaties kan nog wel beschouwd worden als een schatter voor $\mu$ (het werkelijke populatiegemiddelde).
Bemerk dat we in bovenstaande formule alle elementen $N$ uit de populatie beschouwen.
De formule geldt dus voor discreet telbare populaties.
Voor een ruimtelijke continue populatie impliceert dit dat we de ruimte op één of andere manier moeten discretiseren en daar is een definitie voor nodig van wat we beschouwen als een locatie.
Dit is een extra element dat $\sigma_P$ zal vastleggen.

Het feit dat we $Z_i$ observeren voor een locatie in plaats van de werkelijke waarde $Y_i$ voor die locatie wordt veroorzaakt door fouten die niets te maken hebben met het steekproefproces zelf.
Het verschil is het gevolg van fouten die we maken op het terrein en in het labo en geeft aanleiding tot de bemonsteringsfout en de labofout.
Een mogelijke fout op het terrein is bijvoorbeeld het gevolg van verschillen in bemonsterd bodemvolume ten opzichte van vooropgesteld bodemvolume.
Een ander voorbeeld is onzekerheid op de plaatsbepaling van een locatie of het gericht verplaatsen van random geselecteerde locaties (introduceert non-sampling bias).
De term $\sigma^2_B$ stelt de bemonsteringsfout voor bij herhaalde metingen (staalnames) op één locatie uit de $n$ mogelijke locaties van de steekproef.
Hoe groot $\sigma^2_B$ is hangt af de precisie waarmee de plaats bepaald wordt en de stalen genomen worden.
De in het labo gemaakte meetfout $\sigma^2_{LF}$, hangt af van de keuzes die gemaakt worden bij de naverwerking van de stalen en de invloed daarvan op de herhaalbaarheid van een meting $\sigma^2_L$.
De formules tonen dat het aantal staalnamelocaties $n$ verhogen een gunstig effect heeft op elk van de foutenbronnen.
Deze decompositie van variantiebronnen kan vergeleken worden met de kosten geassocieerd met selectie, bemonstering en naverwerking van het staal door een vereenvoudigd lineair kostenmodel te veronderstellen waarmee de totale kost $K_T$ kan berekend worden:

$$K_T = n(K_P + K_B + K_L)$$.

In het huidige steekproefontwerp wordt op een puntlocatie (x, y coördinaat) een staal met gutsboor genomen van een bepaalde diameter.
Soms kan het kostenefficiënt zijn om in twee stappen te werken: een locatie van een bepaalde oppervlakte selecteren (bv 1 m²) en vervolgens binnen deze locatie meerdere substalen te nemen die samen een schatting geven voor de volledige locatie.
Op deze manier ontbinden we de steekproeffout in twee componenten: een variantiecomponent die de afwijking beschrijft van de geschatte locatiespecifieke totalen of gemiddelden ten opzichte van het globaal gemiddelde en een component die de gemiddelde afwijkingen binnen een locatie ten opzichte van locatie-specifieke totalen of gemiddelden beschrijft.
Dit is een tweetrapssteekproef (two-stage sample) (subscript 1 = locatieniveau, subscript 2 = niveau substaal binnen locatie) [@cochran1977]:

$$\mathbf{Var}(\hat{Y})=\mathbf{Var_1}[\mathbf{E_2}(\hat{Y})]+\mathbf{E_1}[\mathbf{Var_2}(\hat{Y})]$$

Een pilootstudie kan uitgevoerd worden om deze componenten in te schatten.
Voor een deel zijn zulke gegevens al beschikbaar uit een MZB exclosure experiment.
Eenmaal een kostenoptimale balans gevonden is tussen aantal locaties ($n$ uit $N$) en aantal substalen binnen een locatie ($m$ uit $M$) uit een pilootstudie, hoeven daarna de individuele substalen niet meer apart geanalyseerd te worden.
Ze kunnen vanaf dan worden samengenomen in een mengstaal per locatie.

@cochran1977 toont aan dat, wanneer we uitgaan van volgend kostenmodel:

$$K_T = nK_1 + nmK_2$$ een optimaal aantal subsamples bekomen wordt indien:

$$m_{opt} = \frac{S_2}{\sqrt{S^2_1 - S^2_2/M}}\frac{\sqrt{K_1}}{\sqrt{K_2}}$$

De hiermee overeenkomende waarde voor een optimaal aantal locaties $n_{opt}$ kan vervolgens gevonden worden door ofwel de kostenvergelijking op te lossen, ofwel de variantievergelijking.
Welke van de twee wordt gekozen is afhankelijk of men uitgaat van een totaal budget of van een vooropgestelde precisie die men wil halen.

### Gebruikte software en packages

Alle analyses werden uitgevoerd in R [@R-base] .
We maken hierbij gebruik van verschillende R packages: `dplyr` [@R-dplyr] voor het voorbereiden van de ruwe data, `ggplot2` [@R-ggplot2] voor aanmaken van figuren, `srvyr` [@R-srvyr] en `survey` [@R-survey] voor design-based inferentie, en `brms` [@R-brms] voor MRP.

<!--chapter:end:02_methoden.Rmd-->

---
bibliography: moneos.bib
---

# Resultaten

## Inschatting tonnage droge biomassa macrozoöbenthos via gestratificeerde aselecte steekproef

```{r svytotal-jaar}
# data.frame maken met alle survey design variabele en responsvariabelen
benthos_design <- benthos_afdw_spatial %>%
  as_survey_design(strata = c(KRWzone, ecotoop_werkelijk.benthos),
                   weights = stratum_weight)

# https://cran.r-project.org/web/packages/srvyr/vignettes/srvyr-vs-survey.html
# Horvitz-Thompson type schatters
benthos_design %>%
  group_by(jaar) %>%
  summarize(
    n = n(),
    totopp_km2 = sum(unique(stratum_opp_m2)) / 1e6,
    mzb_tonnage = survey_total(
    x = tot_afdw / 1e6,
    na.rm = TRUE,
    vartype = "ci",
    level = 0.95)) %>%
  mutate(methode = "H-T") -> svytotal_jaar
```

```{r svytotal-salzone}
# https://cran.r-project.org/web/packages/srvyr/vignettes/srvyr-vs-survey.html
# Horvitz-Thompson type schatters
benthos_design %>%
  group_by(jaar, SalZone) %>%
  summarize(
        n = n(),
        totopp_km2 = sum(unique(stratum_opp_m2)) / 1e6,
        mzb_tonnage = survey_total(
          x = tot_afdw / 1e6,
          na.rm = TRUE,
          vartype = "ci",
          level = 0.95)) %>%
  mutate(methode = "H-T") -> svytotal_salzone
```

```{r svymle, eval=FALSE}
# ofwel droge stof via hurdle gamma distributie?
# cf examples in ?survey::svymle (voor censored lognormal)
# censored kan eventueel ook een optie zijn: alle nullen beschouwen als
# links-gecensureerde data met kleine cutoff
# zie ook ?survey::svysurvreg

# not working
# in terms of linear predictors (lp)
loglike_hurdle_gamma <- function(y, lp_shape, lp_rate, lp_hu) {
  hu <- plogis(lp_hu)
  shape <- exp(lp_shape)
  rate <- exp(lp_rate)
  ifelse(y == 0,
         dbinom(1, 1, hu, log = TRUE),
         dbinom(0, 1, hu, log = TRUE) +
           dgamma(y, shape = shape, rate = rate, log = TRUE)
  )
}

# derivatives with respect to hu, shape and rate

d_lp_shape <- function(y, lp_shape, lp_rate, lp_hu) {
  hu <- plogis(lp_hu)
  shape <- exp(lp_shape)
  rate <- exp(lp_rate)
  d_shape <- ifelse(
    y == 0,
    - (1 - y) / (1 - hu),
    y / hu +
      exp(-rate * y) * y^(shape - 1) * rate^shape / gamma(shape) *
      (log(rate) + log(y) - digamma(shape))
  )
  return(d_shape * shape)
}

d_lp_rate <- function(y, lp_shape, lp_rate, lp_hu) {
  hu <- plogis(lp_hu)
  shape <- exp(lp_shape)
  rate <- exp(lp_rate)
  d_rate <- ifelse(
    y == 0,
    - (1 - y) / (1 - hu),
    y / hu +
      y^(shape - 1) / gamma(shape) * exp(-rate * y) * rate^(shape - 1)
    * (shape - y * rate)
    )
  return(d_rate * rate)
}

d_lp_hu <- function(y, lp_shape, lp_rate, lp_hu) {
  hu <- plogis(lp_hu)
  d_hu <- y / hu - (1 - y) / (1 - hu)
  return(d_hu * (1 / hu + 1 / (1 - hu)) ^ (-1))
}

gradient_hurdle_gamma <- function(y, lp_shape, lp_rate, lp_hu) {
  return(
    cbind(
      d_lp_shape(y, lp_shape, lp_rate, lp_hu),
      d_lp_rate(y, lp_shape, lp_rate, lp_hu),
      d_lp_hu(y, lp_shape, lp_rate, lp_hu)
      )
    )
}

m <- svymle(
  loglike = loglike_hurdle_gamma,
  gradient = gradient_hurdle_gamma,
  design = benthos_design,
  method = "Nelder-Mead",
  formulas = list(~tot_afdw,
                  lp_shape = ~ 0 + jaar,
                  lp_rate = ~ 0 + jaar,
                  lp_hu = ~ 0 + jaar),
  start = list(c(0.5, 0),
               c(0.5, 0),
               c(0.1, 0)
  ),
  control = list(maxit = 10000),
  na.action = "na.omit"
)


summary(m)

# see also https://github.com/strengejacke/sjstats/blob/master/R/svyglmzip.R

# need predict method to obtain population total estimates, but no method for
# svymle


# from ?svymle The usual variance estimator for MLEs in a survey sample is a
# `sandwich' variance that requires the score vector and the information matrix.
# It requires only sampling assumptions to be valid (though some model
# assumptions are required for it to be useful).
# This is the stderr="robust" option, which is available only when the gradient
# argument was specified.
data.frame(est = coef(m), se = SE(m)) %>%
  rownames_to_column(var = "parameter") %>%
  separate(parameter, into = c("parameter", "jaar"), sep = ".jaar")

# combine with var-covar matrix to calculate CI on overall mean?
m$sandwich
all.equal(SE(m), sqrt(diag(m$sandwich)))
samples <- MASS::mvrnorm(n = 1e5, mu = coef(m), Sigma = m$sandwich)

mle_summary <- samples %>%
  as_tibble() %>%
  mutate(
    log_zero_part.2018 = log(1 - plogis(lp_hu.jaar2018)),
    log_gamma_part.2018 = log(exp(lp_shape.jaar2018) / exp(lp_rate.jaar2018)),
    sum_logparts.2018 = log_zero_part.2018 + log_gamma_part.2018,
    log_zero_part.2019 = log(1 - plogis(lp_hu.jaar2019)),
    log_gamma_part.2019 = log(exp(lp_shape.jaar2019) / exp(lp_rate.jaar2019)),
    sum_logparts.2019 = log_zero_part.2019 + log_gamma_part.2019
    ) %>%
  select(starts_with("sum")) %>%
  pivot_longer(cols = everything()) %>%
  separate(name, c("name", "jaar"), sep = "\\.") %>%
  group_by(jaar) %>%
  summarize(y = exp(median(value)) /
              opp_per_staal_m2,
            ymin = exp(quantile(value, 0.025)) /
              opp_per_staal_m2,
            ymax = exp(quantile(value, 0.975)) /
              opp_per_staal_m2,
            y_alternative = mean(exp(value) / opp_per_staal_m2))

# gram per m2
mle_summary

# vergelijk met:
benthos_design %>%
  group_by(jaar) %>%
  summarize(
    n = n(),
    mzb_gram_per_m2 = survey_mean(
    x = tot_afdw / opp_per_staal_m2,
    na.rm = TRUE,
    vartype = "ci",
    level = 0.95))
# er zit zeker nog iets fout
```

```{r replicate-weights, cache=TRUE}
# using replicate weights on a hurdle-gamma regression
benthos_design_repl <- as.svrepdesign(benthos_design)

hg_optim <- withReplicates(
  benthos_design_repl,
  quote(
    glmmTMB(tot_afdw  ~ 0 + jaar,
            family = ziGamma(link = "log"),
            ziformula = ~ 0 + jaar,
            dispformula = ~ 0 + jaar,
            data = model.frame(design),
            weights = .weights,
            se = TRUE,
            na.action = na.omit,
            control = glmmTMBControl(
              optimizer = optim,
              optArgs = list(method = "BFGS")
            ))$fit$par),
  return.replicates = TRUE
)
totopp <- sum(unique(benthos_design$variables$stratum_opp_m2))

hg_optim_estimates <- hg_optim %>%
  as_tibble() %>%
  mutate(param = rep(c("conditional", "hurdle", "dispersion"), each = 2),
         jaar = rep(c("2018", "2019"), times = 3)) %>%
  pivot_wider(id_cols = c(jaar),
              names_from = c(param),
              values_from = c(theta, SE)) %>%
  mutate(overall_mean = (1 - plogis(theta_hurdle)) * exp(theta_conditional),
         mzb_tonnage = overall_mean / opp_per_staal_m2 * totopp / 1e6)

hg_optim_sigma <- attr(hg_optim$theta, which = "var")
hg_optim_mean <- hg_optim$theta

hg_samples <- MASS::mvrnorm(n = 1e5, mu = hg_optim_mean, Sigma = hg_optim_sigma)
colnames(hg_samples) <- paste0(colnames(hg_samples), c(".2018", ".2019"))

hg_summary <- hg_samples %>%
  as_tibble() %>%
  mutate(
    epred.2018 = (1 - plogis(betazi.2018)) * exp(beta.2018),
    epred.2019 = (1 - plogis(betazi.2019)) * exp(beta.2019),
    ) %>%
  select(starts_with("epred")) %>%
  pivot_longer(cols = everything()) %>%
  separate(name, c("name", "jaar"), sep = "\\.") %>%
  group_by(jaar) %>%
  mean_qi(value)
# convert to tonnes
n_samples <- benthos_design$variables %>%
  count(jaar)

hg_summary %>%
  mutate(across(where(is.double) & !.width,
         ~ .x / opp_per_staal_m2 * totopp / 1e6),
         totopp_km2 = totopp / 1e6,
         methode = "RW-J") %>%
    inner_join(n_samples, by = "jaar") %>%
  rename(mzb_tonnage = value,
         mzb_tonnage_low = .lower,
         mzb_tonnage_upp = .upper) -> hg_replicated_jaar
```

```{r replicate-weights-salzone, warning=FALSE, message=FALSE, cache=TRUE}
hg_salzone <- withReplicates(
  design = benthos_design_repl,
  quote(glmmTMB(tot_afdw  ~ 0 + jaar:SalZone,
            family = ziGamma(link = "log"),
            ziformula = ~ 0 + jaar:SalZone,
            dispformula = ~ 0 + jaar:SalZone,
            data = model.frame(design),
            weights = .weights,
            se = TRUE,
            na.action = na.omit
            ,
            control = glmmTMBControl(
              optimizer = optim,
              optArgs = list(method = "BFGS", maxit = 20000)
            )
        )$fit$par
      ),
  return.replicates = TRUE
)
#BFGS did not converge... nor did default algorithm. Really a problem or false?

hg_salzone_sigma <- attr(hg_salzone$theta, which = "var")
hg_salzone_mean <- hg_salzone$theta


hg_salzone_samples <- MASS::mvrnorm(n = 1e5,
                                    mu = hg_salzone_mean,
                                    Sigma = hg_salzone_sigma)
colnames(hg_salzone_samples) <- paste0(
  colnames(hg_salzone_samples),
  paste0(
    c("_2018_", "_2019_"),
    rep(make.names(unique(benthos_design$variables$SalZone)), each = 2)))

hg_salzone_samples <- hg_salzone_samples %>%
  as_tibble() %>%
  mutate(sample = row_number()) %>%
  pivot_longer(-sample) %>%
  separate(name, c("par", "jaar", "SalZone"), sep = "_")

hg_salzone_summary <- hg_salzone_samples %>%
  pivot_wider(names_from = par, values_from = value) %>%
  mutate(
    epred = (1 - plogis(betazi)) * exp(beta)) %>%
  group_by(jaar, SalZone) %>%
  mean_qi(epred)

# convert to tonnes
jointable_salzone <- benthos_design_repl$variables %>%
  group_by(jaar, SalZone) %>%
  summarize(n = n(),
            totopp = sum(unique(stratum_opp_m2)))

hg_salzone_summary %>%
  mutate(SalZone = str_replace_all(SalZone, "\\.", " ")) %>%
  inner_join(jointable_salzone, by = c("jaar", "SalZone")) %>%
  mutate(across(where(is.double) & !.width & !totopp,
         ~ .x / opp_per_staal_m2 * totopp / 1e6),
         methode = "RW-J",
         totopp_km2 = totopp / 1e6) %>%
  select(-totopp) %>%
  rename(mzb_tonnage = epred,
         mzb_tonnage_low = .lower,
         mzb_tonnage_upp = .upper) -> hg_replicated_salzone
```

```{r eval=FALSE}
for (i in 1:194) {
  convergence <- glmmTMB(tot_afdw / opp_per_staal_m2 ~ 0 + jaar:SalZone,
            family = ziGamma(link = "log"),
            ziformula = ~ 0 + jaar:SalZone,
            dispformula = ~ 0 + jaar:SalZone,
            data = model.frame(benthos_design_repl),
            weights = weights(benthos_design_repl)[, i],
            se = TRUE,
            na.action = na.omit,
            control = glmmTMBControl(
              optimizer = optim,
              optArgs = list(method = "BFGS", maxit = 20000)
            ))
  cat(ifelse(convergence$fit$convergence > 0, i, "-"))
}

hg_summary

# vergelijk met:
bd_vergelijk <- benthos_design %>%
  group_by(jaar) %>%
  summarize(
    n = n(),
    mzb_gram_per_m2 = survey_mean(
    x = tot_afdw / opp_per_staal_m2,
    na.rm = TRUE,
    vartype = "ci",
    level = 0.95))

bd_vergelijk

all.equal(hg_summary$y,
          bd_vergelijk$mzb_gram_per_m2)

# lijkt er al beter op
# maar er is nog een klein verschil,
# dat er bijna niet was via rechtstreekse berekening
all.equal(
  hg_optim_estimates$overall_mean,
  bd_vergelijk$mzb_gram_per_m2)
```

```{r mrp-benthos-afdw-poststrat, warning=FALSE}
stratum_n <- benthos_afdw_zs_durme_rupel %>%
  st_drop_geometry() %>%
  filter(!str_detect(ecotoop_werkelijk.benthos, "subtidaal")) %>%
  count(jaar, survey,
        ecotoop_werkelijk = ecotoop_werkelijk.benthos,
        KRWzone, SalZone)

ecotoop %>%
  st_cast("POLYGON") %>%
  select(-Shape_Length, -Shape_Area, -Ecotoop) %>%
  filter(!is.na(NrRandomPunten),
         !str_detect(ecotoop_werkelijk, "subtidaal"),
         Naam %in% c("Zeeschelde", "Durme", "Rupel")) %>%
  mutate(opp_polygoon_m2 = as.numeric(st_area(.))) %>%
  st_drop_geometry() %>%
  group_by(SalZone, KRWzone, ecotoop_werkelijk) %>%
  summarise(stratum_opp_m2 = sum(opp_polygoon_m2),
            .groups = "drop") %>%
  droplevels() %>%
  expand_grid(survey = c("raai", "spatial"),
              jaar = factor(c("2018", "2019"))) %>%
  left_join(
    stratum_n,
    by = c("SalZone", "KRWzone", "survey", "jaar", "ecotoop_werkelijk")) %>%
  mutate(n = ifelse(is.na(n), 0, n)) -> benthos_afdw_poststrat
```

```{r mrp-spatial-model, message=FALSE}
fs::dir_create(find_root_file("src/rapport/brms_models",
                              criterion = is_git_root))
# multilevel regression + poststratification
benthos_afdw_spatial %>%
  rename(ecotoop_werkelijk = ecotoop_werkelijk.benthos) %>%
  st_drop_geometry() %>%
  brm(bf(
    tot_afdw ~
      jaar
    + (1 | jaar:ecotoop_werkelijk)
    + (1 | jaar:KRWzone)
    + (1 | jaar:ecotoop_werkelijk:KRWzone),
    hu ~
      jaar
    + (1 | jaar:ecotoop_werkelijk)
    + (1 | jaar:KRWzone)
    + (1 | jaar:ecotoop_werkelijk:KRWzone)
    ),
  family = hurdle_gamma(),
  data = .,
  silent = 2,
  cores = 4,
  control = list(adapt_delta = 0.95),
  backend = "cmdstanr",
  file = find_root_file("src/rapport/brms_models/mrp_spatial",
                        criterion = is_git_root),
  file_refit = "on_change"
  ) -> mrp_spatial
```

```{r mrp-spatial-jaar}
poststrat_spatial <- benthos_afdw_poststrat %>%
  filter(survey == "spatial")

mrp_spatial %>%
  add_epred_draws(newdata = poststrat_spatial) %>%
  # omzetting naar ton per stratum per jaar
  mutate(.epred = .epred / opp_per_staal_m2 * stratum_opp_m2 / 1e6) %>%
  # sommering naar ton voor gewenste groepering in elk jaar
  group_by(jaar, .draw) %>%
  summarise(.epred = sum(.epred),
            .groups = "drop_last") %>%
  # berekening modus en interval
  group_by(jaar) %>%
  mode_hdci(.epred) %>%
  rename(mzb_tonnage = .epred,
         mzb_tonnage_low = .lower,
         mzb_tonnage_upp = .upper) %>%
  inner_join(poststrat_spatial %>%
               group_by(jaar) %>%
               summarize(n = sum(n),
                         totopp_km2 = sum(stratum_opp_m2) / 1e6),
             by = "jaar"
             ) %>%
  mutate(methode = "MRP") -> mrp_spatial_jaar
```

```{r eval=FALSE}
mrp_spatial %>%
  add_epred_draws(newdata = poststrat_spatial) %>%
  mutate(.epred = .epred / opp_per_staal_m2 * stratum_opp_m2 / 1e6) %>%
  # sommering naar ton voor gewenste groepering in elk jaar
  group_by(jaar, .draw) %>%
  summarise(.epred = sum(.epred),
            totopp_km2 = sum(stratum_opp_m2) / 1e6,
            .groups = "drop_last") %>%
  ggplot(aes(x = .epred, y = jaar)) +
  stat_halfeye(point_interval = mode_hdci, .width = c(.66, .95))

mrp_spatial %>%
  add_epred_draws(newdata = poststrat_spatial) %>%
  mutate(.epred = .epred / opp_per_staal_m2 * stratum_opp_m2 / 1e6) %>%
  # sommering naar ton voor gewenste groepering in elk jaar
  group_by(jaar, .draw) %>%
  summarise(.epred = sum(.epred),
            totopp_km2 = sum(stratum_opp_m2) / 1e6,
            .groups = "drop_last") %>%
  ggplot(aes(x = .epred, y = jaar)) +
  stat_halfeye(point_interval = median_qi, .width = c(.66, .95))
```

```{r mrp-spatial-salzone}
mrp_spatial %>%
  add_epred_draws(newdata = poststrat_spatial) %>%
  # omzetting naar ton per stratum per jaar
  mutate(.epred = .epred / opp_per_staal_m2 * stratum_opp_m2 / 1e6) %>%
  # sommering naar ton voor gewenste groepering in elk jaar
  group_by(jaar, SalZone, .draw) %>%
  summarise(.epred = sum(.epred),
            .groups = "drop_last") %>%
  # berekening modus en interval
  group_by(jaar, SalZone) %>%
  mode_hdci(.epred) %>%
  rename(mzb_tonnage = .epred,
         mzb_tonnage_low = .lower,
         mzb_tonnage_upp = .upper) %>%
  inner_join(poststrat_spatial %>%
               group_by(jaar, SalZone) %>%
               summarize(n = sum(n),
                         totopp_km2 = sum(stratum_opp_m2) / 1e6,
                         .groups = "drop"),
             by = c("jaar", "SalZone")
             ) %>%
  mutate(methode = "MRP") -> mrp_spatial_salzone
```

De drie methoden verschillen in de geschatte totale biomassa MZB (Tabel \@ref(tab:schattingen-overzichtstabel)), maar deze schattingen liggen wel binnen elk van de drie 95% intervallen.
Bij de Horvitz-Thompson schatter is het geschatte totaal duidelijk lager.
Dit geschatte totaal stemt overeen met de manier waarop de biomassa-totalen gerapporteerd worden [zie bv @ryckegem2020].
Het interval rond de Horvitz-Thompson schatter is per definitie symmetrisch, terwijl de andere methoden asymmetrische intervallen opleveren.
Dit type van schatters is betrouwbaar op voorwaarde dat de steekproef voldoende groot is en er geen invloedrijke datapunten zijn.
Wellicht is aan beide voorwaarden onvoldoende voldaan en dit komt nog beter tot uiting bij de subtotalen per saliniteitszone waar het interval soms negatieve waarden omvat (Tabel \@ref(tab:schattingen-overzichtstabel-salzone)).
De twee andere methoden stemmen beter overeen.
Beide methoden maken gebruik van een hurdle-gamma assumptie voor de verdeling van de biomassagegevens, maar ze verschillen sterk in de manier waarop rekening wordt gehouden met het steekproefontwerp.
In het `RW-J` geval wordt de onzekerheid op de schatting volledig bepaald door Jackknife-herhalingen.
In het model zelf zitten dan geen designvariabelen (enkel de factor jaar of jaar en saliniteitszone waar we een schatting voor willen).
Bij de MRP methode zitten de designvariabelen wel bij in het model (als random effecten).
De MRP schattingen lijken systematisch iets hoger te liggen dan de schattingen gebaseerd op de Jackknife herhalingen.

(ref:schattingen-overzichtstabel) Schatting van tonnages biomassa MZB volgens verschillende methodes in de intertidale zone van de Zeeschelde en Durme opgesplitst per jaar. rfm = relatieve foutenmarge.

```{r schattingen-overzichtstabel}
tab <- bind_rows(svytotal_jaar, hg_replicated_jaar, mrp_spatial_jaar) %>%
  select(jaar, methode, n, totopp_km2, starts_with("mzb")) %>%
  mutate(n = as.integer(n),
         rfm = (mzb_tonnage_upp - mzb_tonnage_low) / (2 * mzb_tonnage)) %>%
  arrange(desc(methode), jaar) %>%
  group_by(jaar) %>%
  gt(caption = "(ref:schattingen-overzichtstabel)") %>%
  fmt_number(columns = starts_with("mzb"), decimals = 1) %>%
  fmt_number(columns = rfm, decimals = 2) %>%
  fmt_number(columns = totopp_km2, decimals = 1)

if (knitr::is_latex_output()) {
  as_latex_with_caption(tab, "schattingen-overzichtstabel")
} else {
  tab
}
```

De drie methoden verschillen in de conclusies die getrokken kunnen worden wanneer de betrouwbaarheidsintervallen vergelijken met de doelstelling van 30 ton MZB (Figuur \@ref(fig:plot-jaar)).
Volgens de MRP methode is er in beide jaren een hoger tonnage dan minimaal vooropgesteld wordt.
Volgens de RW-J methode is dat enkel in 2019 het geval en volgens de Horvitz-Thompson schatter is het in geen van beide jaren het geval.

(ref:plot-jaar) Vergelijking van de geschatte betrouwbaarheidsintervallen volgens de drie methoden met de doelstelling voor biomassa MZB in het volledige systeem.

```{r plot-jaar, fig.cap="(ref:plot-jaar)"}
bind_rows(svytotal_jaar, hg_replicated_jaar, mrp_spatial_jaar) %>%
  select(jaar, methode, n, totopp_km2, starts_with("mzb")) %>%
  ggplot() +
  geom_pointrange(aes(
    x = jaar,
    y = mzb_tonnage,
    ymin = mzb_tonnage_low,
    ymax = mzb_tonnage_upp,
    colour = methode
  ),
  position = position_dodge(width = 0.6)) +
  geom_hline(aes(yintercept = 30))
```

(ref:schattingen-overzichtstabel-salzone) Schatting van tonnages biomassa MZB volgens verschillende methodes in de intertidale zone van de Zeeschelde en Durme opgesplitst per jaar en saliniteitszone.

```{r schattingen-overzichtstabel-salzone}
tab <- bind_rows(svytotal_salzone, hg_replicated_salzone, mrp_spatial_salzone) %>%
  select(jaar, SalZone, methode, n, totopp_km2, starts_with("mzb")) %>%
  mutate(n = as.integer(n),
         rfm = (mzb_tonnage_upp - mzb_tonnage_low) / (2 * mzb_tonnage)) %>%
  arrange(desc(methode), jaar, SalZone) %>%
  group_by(jaar, SalZone) %>%
  gt(caption = "(ref:schattingen-overzichtstabel-salzone)") %>%
  fmt_number(columns = starts_with("mzb"), decimals = 1) %>%
  fmt_number(columns = rfm, decimals = 2) %>%
  fmt_number(columns = totopp_km2, decimals = 1)

if (knitr::is_latex_output()) {
  as_latex_with_caption(tab, "schattingen-overzichtstabel-salzone")
} else {
  tab
}
```

Figuur \@ref(fig:plot-salzone) geeft aan dat meestal de betrouwbaarheidsintervallen overlappen met de doelstelling.
Voor het oligohalien zitten de locatieschattingen meestal onder de doelstelling, voor de andere zones zitten ze erboven.

(ref:plot-salzone) Vergelijking van de geschatte betrouwbaarheidsintervallen volgens de drie methoden met de doelstelling voor biomassa MZB per saliniteitszone.

```{r plot-salzone, fig.cap = "(ref:plot-salzone)"}
bind_rows(svytotal_salzone, hg_replicated_salzone, mrp_spatial_salzone) %>%
  select(jaar, SalZone, methode, n, totopp_km2, starts_with("mzb")) %>%
  mutate(n = as.integer(n)) %>%
  ggplot() +
  geom_pointrange(aes(
    x = jaar,
    y = mzb_tonnage,
    ymin = mzb_tonnage_low,
    ymax = mzb_tonnage_upp,
    colour = methode
  ),
  position = position_dodge(width = 0.6)) +
  geom_hline(data = mzb_targets,
             aes(yintercept = doel)) +
  facet_grid(~ SalZone, labeller = label_wrap_gen(width = 20))
```

```{r eval=FALSE}
benthos_afdw_zs_durme_rupel %>%
  filter(tidaal == "subtidaal",
         Z > 0) %>%
  st_drop_geometry() %>%
  select(jaar, staal, ecotoop_werkelijk.benthos, KRWzone, Z) %>%
  gt()
```

## Inschatting aan de hand van enkel raaigegevens

```{r svytotal-raai-jaar}
# data.frame maken met alle survey design variabele en responsvariabelen
benthos_raai_design <- benthos_afdw_raai %>%
  as_survey_design(strata = c(KRWzone, ecotoop_werkelijk.benthos),
                   weights = stratum_weight)


benthos_raai_design %>%
  group_by(jaar) %>%
  summarise(
    n_raaien = n_distinct(staalcode),
    n = n(),
    totopp_km2 = sum(unique(stratum_opp_m2)) / 1e6,
    mzb_tonnage = survey_total(
      x = tot_afdw / 1e6,
      na.rm = TRUE,
      vartype = "ci",
      level = 0.95),
    .groups = "drop") %>%
  mutate(methode = "H-T") -> svytotal_raai_jaar
```

```{r svytotal-raai-salzone}
benthos_raai_design %>%
  group_by(jaar, SalZone) %>%
  summarise(
    n_raaien = n_distinct(staalcode),
    n = n(),
    totopp_km2 = sum(unique(stratum_opp_m2)) / 1e6,
    mzb_tonnage = survey_total(
      x = tot_afdw / 1e6,
      na.rm = TRUE,
      vartype = "ci",
      level = 0.95),
    .groups = "drop_last") %>%
  mutate(methode = "H-T") -> svytotal_raai_salzone
```

```{r mrp-raai-model}
benthos_afdw_raai %>%
  rename(ecotoop_werkelijk = ecotoop_werkelijk.benthos) %>%
  st_drop_geometry() %>%
  brm(bf(
    tot_afdw ~
      jaar
    + (1 | jaar:ecotoop_werkelijk)
    + (1 | jaar:KRWzone)
    + (1 | jaar:ecotoop_werkelijk:KRWzone),
    hu ~
      jaar
    + (1 | jaar:ecotoop_werkelijk)
    + (1 | jaar:KRWzone)
    + (1 | jaar:ecotoop_werkelijk:KRWzone)
  ),
  family = hurdle_gamma(),
  data = .,
  silent = 2,
  cores = 4,
  control = list(adapt_delta = 0.95),
  backend = "cmdstanr",
  file = find_root_file("src/rapport/brms_models/mrp_raai",
                        criterion = is_git_root),
  file_refit = "on_change"
  ) -> mrp_raai
```

```{r mrp-raai-clusters-model, eval=FALSE}
# toevoegen van random effect staalcode en staal geeft zeer brede BI's
benthos_afdw_raai %>%
  rename(ecotoop_werkelijk = ecotoop_werkelijk.benthos) %>%
  st_drop_geometry() %>%
  brm(bf(
    tot_afdw ~
      jaar
    + (1 | jaar:ecotoop_werkelijk)
    + (1 | jaar:KRWzone)
    + (1 | jaar:ecotoop_werkelijk:KRWzone)
    + (1 | staalcode)
    + (1 | staalcode:staal),
    hu ~
      jaar
    + (1 | jaar:ecotoop_werkelijk)
    + (1 | jaar:KRWzone)
    + (1 | jaar:ecotoop_werkelijk:KRWzone)
    + (1 | staalcode)
    + (1 | staalcode:staal)
    ),
  family = hurdle_gamma(),
  data = .,
  silent = 2,
  cores = 4,
  control = list(adapt_delta = 0.95),
  backend = "cmdstanr",
  file = find_root_file("src/rapport/brms_models/mrp_raai_clusters",
                        criterion = is_git_root),
  file_refit = "on_change"
  ) -> mrp_raai_clusters

mrp_raai_clusters

# proberen met enkel effect van locatie (staal)
benthos_afdw_raai %>%
  rename(ecotoop_werkelijk = ecotoop_werkelijk.benthos) %>%
  st_drop_geometry() %>%
  brm(bf(
    tot_afdw ~
      jaar
    + (1 | jaar:ecotoop_werkelijk)
    + (1 | jaar:KRWzone)
    + (1 | jaar:ecotoop_werkelijk:KRWzone)
    + (1 | staal),
    hu ~
      jaar
    + (1 | jaar:ecotoop_werkelijk)
    + (1 | jaar:KRWzone)
    + (1 | jaar:ecotoop_werkelijk:KRWzone)
    + (1 | staal)
    ),
  family = hurdle_gamma(),
  data = .,
  silent = 2,
  cores = 4,
  control = list(adapt_delta = 0.95),
  backend = "cmdstanr",
  file = find_root_file("src/rapport/brms_models/mrp_raai_gepaard",
                        criterion = is_git_root),
  file_refit = "on_change"
  ) -> mrp_raai_gepaard

mrp_raai_gepaard
```

```{r mrp-raai-clusters-jaar, eval=FALSE}
# vermoedelijk is onderstaande berekening niet juist.
# staalcode en staal wordt hier impliciet op NA gezet
# maar de effecten van staalcode en staal moeten gemarginaliseerd worden
# en dat vereist integratie over de random effecten
# kan wellicht met 
# https://cran.r-project.org/web/packages/brmsmargins/index.html

poststrat_raai <- benthos_afdw_poststrat %>%
  filter(survey == "raai")

mrp_raai_clusters %>%
  add_epred_draws(newdata = poststrat_raai,
                  allow_new_levels = TRUE) %>%
  # omzetting naar ton per stratum per jaar
  mutate(.epred = .epred / opp_per_staal_m2 * stratum_opp_m2 / 1e6) %>%
  # sommering naar ton voor gewenste groepering in elk jaar
  group_by(jaar, .draw) %>%
  summarise(.epred = sum(.epred),
            .groups = "drop_last") %>%
  # berekening modus en interval
  group_by(jaar) %>%
  filter(.epred < quantile(.epred, 0.999)) %>%
  mode_hdci(.epred) %>%
  rename(mzb_tonnage = .epred,
         mzb_tonnage_low = .lower,
         mzb_tonnage_upp = .upper) %>%
  inner_join(poststrat_raai %>%
               group_by(jaar) %>%
               summarize(n = sum(n),
                         totopp_km2 = sum(stratum_opp_m2) / 1e6),
             by = "jaar"
             ) %>%
  mutate(methode = "MRP") -> mrp_raai_clusters_jaar

mrp_raai_gepaard %>%
  add_epred_draws(newdata = poststrat_raai,
                  allow_new_levels = TRUE) %>%
  # omzetting naar ton per stratum per jaar
  mutate(.epred = .epred / opp_per_staal_m2 * stratum_opp_m2 / 1e6) %>%
  # sommering naar ton voor gewenste groepering in elk jaar
  group_by(jaar, .draw) %>%
  summarise(.epred = sum(.epred),
            .groups = "drop_last") %>%
  # berekening modus en interval
  group_by(jaar) %>%
  filter(.epred < quantile(.epred, 0.999)) %>%
  mode_hdci(.epred) %>%
  rename(mzb_tonnage = .epred,
         mzb_tonnage_low = .lower,
         mzb_tonnage_upp = .upper) %>%
  inner_join(poststrat_raai %>%
               group_by(jaar) %>%
               summarize(n = sum(n),
                         totopp_km2 = sum(stratum_opp_m2) / 1e6),
             by = "jaar"
             ) %>%
  mutate(methode = "MRP") -> mrp_raai_gepaard_jaar
```

```{r mrp-raai-jaar}
poststrat_raai <- benthos_afdw_poststrat %>%
  filter(survey == "raai")

mrp_raai %>%
  add_epred_draws(newdata = poststrat_raai,
                  allow_new_levels = TRUE) %>%
  # omzetting naar ton per stratum per jaar
  mutate(.epred = .epred / opp_per_staal_m2 * stratum_opp_m2 / 1e6) %>%
  # sommering naar ton voor gewenste groepering in elk jaar
  group_by(jaar, .draw) %>%
  summarise(.epred = sum(.epred),
            .groups = "drop_last") %>%
  # berekening modus en interval
  group_by(jaar) %>%
  filter(.epred < quantile(.epred, 0.999)) %>%
  mode_hdci(.epred) %>%
  rename(mzb_tonnage = .epred,
         mzb_tonnage_low = .lower,
         mzb_tonnage_upp = .upper) %>%
  inner_join(poststrat_raai %>%
               group_by(jaar) %>%
               summarize(n = sum(n),
                         totopp_km2 = sum(stratum_opp_m2) / 1e6),
             by = "jaar"
             ) %>%
  mutate(methode = "MRP") -> mrp_raai_jaar
```

```{r mrp-raai-salzone}
mrp_raai %>%
  add_epred_draws(newdata = poststrat_raai,
                  allow_new_levels = TRUE) %>%
  # omzetting naar ton per stratum per jaar
  mutate(.epred = .epred / opp_per_staal_m2 * stratum_opp_m2 / 1e6) %>%
  # sommering naar ton voor gewenste groepering in elk jaar
  group_by(jaar, SalZone, .draw) %>%
  summarise(.epred = sum(.epred),
            .groups = "drop_last") %>%
  # berekening modus en interval
  group_by(jaar, SalZone) %>%
  filter(.epred < quantile(.epred, 0.999)) %>%
  mode_hdci(.epred) %>%
  rename(mzb_tonnage = .epred,
         mzb_tonnage_low = .lower,
         mzb_tonnage_upp = .upper) %>%
  inner_join(poststrat_raai %>%
               group_by(jaar, SalZone) %>%
               summarize(n = sum(n),
                         totopp_km2 = sum(stratum_opp_m2) / 1e6,
                         .groups = "drop_last"),
             by = c("jaar", "SalZone")
             ) %>%
  mutate(methode = "MRP") -> mrp_raai_salzone
```

Indien we de Horvitz-Thompson en MRP methode toepassen op enkel de gegevens van de raaien, bekomen we duidelijk andere cijfers dan die bekomen via de gestratificeerde steekproef (zie tabellen \@ref(tab:schattingen-raai-overzichtstabel) en \@ref(tab:schattingen-raai-overzichtstabel-salzone)).
Vooral in 2019 ligt de schatting veel hoger vergeleken met de gestratificeerde steekproef.
De punten langs de raaien zijn vrij gelijk verdeeld over de hoogtegradiënt.
Bij de spatial survey hangt dit af van toevalligheden veroorzaakt door de jaarlijkse randomisatie.
Mogelijk zou dit kunnen verklaren waarom in 2019 in de spatial survey er een lagere biomassa bekomen wordt indien in 2019 toevallig ook de punten lager langs de hoogtegradiënt liggen.
Er is immers een toename van de biomassa met de hoogte (vooral langs de hoogtegradiënt in de lage en middelhoge intertidale zone is dit te zien; zie ook sectie \@ref(biomassa-hoogte-relatie)) [@braeckel2020].
Als we figuur \@ref(fig:hoogteligging-survey) bekijken, blijkt dit beperkt het geval te zijn in het Oligohalien en de zone met sterke saliniteitsgradiënt.
In de zone zoet met lange verblijftijd zien we echter het omgekeerde.
Het lijkt dus eerder onwaarschijnlijk dat alleen verschillen in hoogte tussen de jaren het grote verschil in biomassa tussen raai en survey in 2019 verklaren.

(ref:hoogteligging-survey) Boxplots van de hoogteligging van de bemonsterde locaties in beide jaren en voor beide survey-types.

```{r hoogteligging-survey, fig.cap = "(ref:hoogteligging-survey)"}
datahs <- benthos_afdw_zs_durme_rupel %>%
  st_drop_geometry() %>%
  filter(
    tidaal == "intertidaal",
    Z >= 0)

datahs %>%
  ggplot() + 
  geom_boxplot(aes(x = survey, y = Z, fill = jaar),
               alpha = 0.3) +
  geom_point(aes(x = survey, y = Z, colour = jaar),
              alpha = 0.3,
              position = position_dodge(width = 0.75)) +
  labs(y = "Hoogteligging boven laagwater 30 in m") +
  facet_wrap(~SalZone)
```

De berekeningen voor de raaien op basis van Horvitz-Thompson schatters zijn echter fout om minstens twee redenen: (1) de doelpopulatie is verschillend, en (2) we gebruiken design-based inferentie terwijl het geen probabilistische steekproef betreft.
Wellicht zijn dit sterk vertekende schattingen (overschatting vermits vooral in beste gebieden).
Bovendien bekomen we bredere betrouwbaarheidsintervallen ondanks een hoger aantal locaties die via raaien bemonsterd worden in het intertidaal (150 versus 100-tal).

Voor de MRP schattingen is het belangrijk om eerst op te merken dat er twee manieren zijn om de poststratificatie schattingen voor raaien te berekenen:

1.  ofwel poststrata waarin geen raaien verwijderen => veranderen van de doelpopulatie

2.  ofwel alle poststrata behouden en het model predicties laten doen voor poststrata zonder data

    -   in dat geval zullen de geschatte "gemiddelde" biomassa ongeveer gelijk blijven
    -   maar interval zal breder zijn

In de tabellen staan de resultaten voor het tweede geval zodat de MRP methode een cijfer kan geven dat overeenstemt met de doelpopulatie (intertidale deel van Zeeschelde, Durme, Rupel).
Dit is ook de kracht van MRP analyses omdat ze toelaten om voor poststratificatiecellen waarvoor er weinig of geen gegevens zijn, toch predicties te doen op basis van similariteiten met andere kenmerken waarvan er wel gegevens zijn (ook wel *smoothing* of *partial pooling* genoemd).
Dit zal uiteraard wel bijdragen aan verhoogde onzekerheid over de schatting en dus resulteren in brede betrouwbaarheidsintervallen.
Voor de MRP analyse op basis van enkel de raaigegevens, zaten in de posterior samples extreem hoge waarden voor de geschatte biomassa.
Om stabiele schattingen te krijgen werden daarom de 0.1% hoogste waarden verwijderd alvorens berekening van de modus en het interval.

(ref:schattingen-raai-overzichtstabel) Schatting van tonnages biomassa MZB volgens verschillende methodes in de intertidale zone van de Zeeschelde en Durme opgesplitst per jaar.

```{r schattingen-raai-overzichtstabel}
tab <- bind_rows(svytotal_raai_jaar, mrp_raai_jaar) %>%
  select(jaar, methode, n_raaien, n, totopp_km2, starts_with("mzb")) %>%
  mutate(n = as.integer(n),
         n_raaien = as.integer(n_raaien)) %>%
  arrange(desc(methode), jaar) %>%
  group_by(jaar) %>%
  gt(caption = "(ref:schattingen-raai-overzichtstabel)") %>%
  fmt_number(columns = where(is.double), decimals = 1)

if (knitr::is_latex_output()) {
  as_latex_with_caption(tab, "schattingen-raai-overzichtstabel")
} else {
  tab
}
```

(ref:schattingen-raai-overzichtstabel-salzone) Schatting van tonnages biomassa MZB volgens verschillende methodes in de intertidale zone van de Zeeschelde en Durme opgesplitst per jaar en saliniteitszone.

```{r schattingen-raai-overzichtstabel-salzone}
tab <- bind_rows(svytotal_raai_salzone, mrp_raai_salzone) %>%
  select(jaar, SalZone, methode, n_raaien, n, totopp_km2,
         starts_with("mzb")) %>%
  mutate(n = as.integer(n),
         n_raaien = as.integer(n_raaien)) %>%
  arrange(desc(methode), jaar, SalZone) %>%
  group_by(jaar, SalZone) %>%
  gt(caption = "(ref:schattingen-raai-overzichtstabel-salzone)") %>%
  fmt_number(columns = where(is.double), decimals = 1)

if (knitr::is_latex_output()) {
  as_latex_with_caption(tab, "schattingen-raai-overzichtstabel-salzone")
} else {
  tab
}
```

## Vergelijking spatial en raai surveys

Figuur \@ref(fig:plot-ruwe-data) visualiseert de ruwe biomassadata.
De gemiddelde en betrouwbaarheidsintervallen die hierop getoond worden houden geen rekening met de oppervlaktes van de strata.
De figuur geeft wel een eerste indicatie van de moeilijkheden die er zijn bij een vergelijking tussen de raaigegevens en de gegevens afkomstig van de spatial survey.

(ref:plot-ruwe-data) Geobserveerde biomassa MZB is weergegeven door de cirkels. De grootte van de cirkels is evenredig met het aantal locaties in het geval dezelfde biomassa werd geobserveerd. Kruisjes geven de gemiddelde waarde aan en de betrouwbaarheidsintervallen zijn 95% bootstrap intervallen. De y-as is voorgesteld als een semi-logarithmische schaal (met een zachte overgang naar een lineaire schaal voor waarden dichtbij nul).

```{r plot-ruwe-data, fig.cap = "(ref:plot-ruwe-data)", warning=FALSE}
benthos_afdw_zs_durme_rupel %>%
  filter(tidaal != "subtidaal") %>%
  rename(ecotoop_werkelijk = ecotoop_werkelijk.benthos) %>%
  st_drop_geometry() %>%
  ggplot() +
  stat_sum(aes(x = survey,
               y = tot_afdw / opp_per_staal_m2,
               colour = ecotoop_werkelijk),
           position = position_dodge(width = 0.6),
           alpha = 0.5) +
  stat_summary(aes(x = survey,
                   y = tot_afdw / opp_per_staal_m2,
                   colour = ecotoop_werkelijk),
               position = position_dodge(width = 0.6),
               fun.data = mean_cl_boot,
               shape = "cross") +
  facet_grid(jaar ~ KRWzone + SalZone,
             labeller = label_wrap_gen(width = 20)) +
  scale_y_continuous("MZB gram per m²",
                     trans = "pseudo_log",
                     breaks = c(0, 1, 2, 5, 10, 20, 50, 100, 200))
```

```{r mrp-raaispatial-model}
benthos_afdw_zs_durme_rupel %>%
  filter(tidaal != "subtidaal") %>%
  rename(ecotoop_werkelijk = ecotoop_werkelijk.benthos) %>%
  st_drop_geometry() %>%
  brm(bf(
    tot_afdw ~
      jaar
    + survey
    + jaar:survey
    + (1 | survey:jaar:ecotoop_werkelijk)
    + (1 | survey:jaar:KRWzone)
    + (1 | survey:jaar:ecotoop_werkelijk:KRWzone),
    hu ~
      jaar
    + survey
    + jaar:survey
    + (1 | survey:jaar:ecotoop_werkelijk)
    + (1 | survey:jaar:KRWzone)
    + (1 | survey:jaar:ecotoop_werkelijk:KRWzone)
  ),
  family = hurdle_gamma(),
  data = .,
  silent = 2,
  cores = 4,
  control = list(adapt_delta = 0.95),
  backend = "cmdstanr",
  file = find_root_file("src/rapport/brms_models/mrp_raaispatial",
                        criterion = is_git_root),
  file_refit = "on_change"
  ) -> mrp_raaispatial
```

```{r mrp-raaispatial-2-model}
benthos_afdw_zs_durme_rupel %>%
  filter(tidaal != "subtidaal") %>%
  rename(ecotoop_werkelijk = ecotoop_werkelijk.benthos) %>%
  st_drop_geometry() %>%
  brm(bf(
    tot_afdw ~
      jaar
    + (1 | jaar:ecotoop_werkelijk)
    + (1 | jaar:KRWzone)
    + (1 | jaar:ecotoop_werkelijk:KRWzone),
    hu ~
      jaar
    + (1 | jaar:ecotoop_werkelijk)
    + (1 | jaar:KRWzone)
    + (1 | jaar:ecotoop_werkelijk:KRWzone)
  ),
  family = hurdle_gamma(),
  data = .,
  silent = 2,
  cores = 4,
  control = list(adapt_delta = 0.95),
  backend = "cmdstanr",
  file = find_root_file("src/rapport/brms_models/mrp_raaispatial_2",
                        criterion = is_git_root),
  file_refit = "on_change"
  ) -> mrp_raaispatial_2
```

```{r mrp-raaispatial-jaar}
mrp_raaispatial %>%
  add_epred_draws(newdata = benthos_afdw_poststrat,
                  allow_new_levels = TRUE) %>%
  # omzetting naar ton per stratum per jaar
  mutate(.epred = .epred / opp_per_staal_m2 * stratum_opp_m2 / 1e6) %>%
  # sommering naar ton voor gewenste groepering in elk jaar
  group_by(survey, jaar, .draw) %>%
  summarise(.epred = sum(.epred),
            .groups = "drop_last") %>%
  # berekening modus en interval
  group_by(survey, jaar) %>%
  mode_hdci(.epred) %>%
  rename(mzb_tonnage = .epred,
         mzb_tonnage_low = .lower,
         mzb_tonnage_upp = .upper) %>%
  inner_join(benthos_afdw_poststrat %>%
               group_by(survey, jaar) %>%
               summarize(n = sum(n),
                         totopp_km2 = sum(stratum_opp_m2) / 1e6,
                         .groups = "drop"),
             by = c("survey", "jaar")
             ) %>%
  mutate(methode = "MRP") -> mrp_raaispatial_jaar
```

```{r mrp-raaispatial-salzone}
mrp_raaispatial %>%
  add_epred_draws(newdata = benthos_afdw_poststrat,
                  allow_new_levels = TRUE) %>%
  # omzetting naar ton per stratum per jaar
  mutate(.epred = .epred / opp_per_staal_m2 * stratum_opp_m2 / 1e6) %>%
  # sommering naar ton voor gewenste groepering in elk jaar
  group_by(survey, jaar, SalZone, .draw) %>%
  summarise(.epred = sum(.epred),
            .groups = "drop_last") %>%
  # berekening modus en interval
  group_by(survey, jaar, SalZone) %>%
  mode_hdci(.epred) %>%
  rename(mzb_tonnage = .epred,
         mzb_tonnage_low = .lower,
         mzb_tonnage_upp = .upper) %>%
  inner_join(benthos_afdw_poststrat %>%
               group_by(survey, jaar, SalZone) %>%
               summarize(n = sum(n),
                         totopp_km2 = sum(stratum_opp_m2) / 1e6,
                         .groups = "drop"),
             by = c("survey", "jaar", "SalZone")
             ) %>%
  mutate(methode = "MRP") -> mrp_raaispatial_salzone
```

```{r mrp-raaispatial-ecotoop}
mrp_raaispatial %>%
  add_epred_draws(newdata = benthos_afdw_poststrat,
                  allow_new_levels = TRUE) %>%
  # omzetting naar ton per stratum per jaar
  mutate(.epred = .epred / opp_per_staal_m2 * stratum_opp_m2 / 1e6) %>%
  # sommering naar ton voor gewenste groepering in elk jaar
  group_by(survey, jaar, ecotoop_werkelijk, .draw) %>%
  summarise(.epred = sum(.epred),
            .groups = "drop_last") %>%
  # berekening modus en interval
  group_by(survey, jaar, ecotoop_werkelijk) %>%
  mode_hdci(.epred) %>%
  rename(mzb_tonnage = .epred,
         mzb_tonnage_low = .lower,
         mzb_tonnage_upp = .upper) %>%
  inner_join(benthos_afdw_poststrat %>%
               group_by(survey, jaar, ecotoop_werkelijk) %>%
               summarize(n = sum(n),
                         totopp_km2 = sum(stratum_opp_m2) / 1e6,
                         .groups = "drop"),
             by = c("survey", "jaar", "ecotoop_werkelijk")
             ) %>%
  mutate(methode = "MRP") -> mrp_raaispatial_ecotoop
```

```{r mrp-raaispatial-salzone-ecotoop}
mrp_raaispatial %>%
  add_epred_draws(newdata = benthos_afdw_poststrat,
                  allow_new_levels = TRUE) %>%
  # omzetting naar ton per stratum per jaar
  mutate(.epred = .epred / opp_per_staal_m2 * stratum_opp_m2 / 1e6) %>%
  # sommering naar ton voor gewenste groepering in elk jaar
  group_by(survey, jaar, SalZone, ecotoop_werkelijk, .draw) %>%
  summarise(.epred = sum(.epred),
            .groups = "drop_last") %>%
  # berekening modus en interval
  group_by(survey, jaar, SalZone, ecotoop_werkelijk) %>%
  mode_hdci(.epred) %>%
  rename(mzb_tonnage = .epred,
         mzb_tonnage_low = .lower,
         mzb_tonnage_upp = .upper) %>%
  inner_join(benthos_afdw_poststrat %>%
               group_by(survey, jaar, SalZone, ecotoop_werkelijk) %>%
               summarize(n = sum(n),
                         totopp_km2 = sum(stratum_opp_m2) / 1e6,
                         .groups = "drop"),
             by = c("survey", "jaar", "SalZone", "ecotoop_werkelijk")
             ) %>%
  mutate(methode = "MRP") -> mrp_rsp_salzone_ecotoop
```

```{r mrp-raaispatial-2-jaar}
# model zonder survey => poststrata ook survey verwijderen anders dubbeltelling
benthos_afdw_ps_zonder_survey <- benthos_afdw_poststrat %>%
  group_by(SalZone, KRWzone, ecotoop_werkelijk, jaar, stratum_opp_m2) %>%
  summarise(n_raai = sum(n[survey == "raai"]),
            n_spatial = sum(n[survey == "spatial"]),
            n = sum(n),
            .groups = "drop")

mrp_raaispatial_2 %>%
  add_epred_draws(newdata = benthos_afdw_ps_zonder_survey) %>%
  # omzetting naar ton per stratum per jaar
  mutate(.epred = .epred / opp_per_staal_m2 * stratum_opp_m2 / 1e6) %>%
  # sommering naar ton voor gewenste groepering in elk jaar
  group_by(jaar, .draw) %>%
  summarise(.epred = sum(.epred),
            .groups = "drop_last") %>%
  # berekening modus en interval
  group_by(jaar) %>%
  mode_hdci(.epred) %>%
  rename(mzb_tonnage = .epred,
         mzb_tonnage_low = .lower,
         mzb_tonnage_upp = .upper) %>%
  inner_join(benthos_afdw_ps_zonder_survey %>%
               group_by(jaar) %>%
               summarize(n = sum(n),
                         n_raai = sum(n_raai),
                         n_spatial = sum(n_spatial),
                         totopp_km2 = sum(stratum_opp_m2) / 1e6),
             by = "jaar"
             ) %>%
  mutate(methode = "MRP") -> mrp_raaispatial2_jaar
```

```{r mrp-raaispatial-2-salzone}
mrp_raaispatial_2 %>%
  add_epred_draws(newdata = benthos_afdw_ps_zonder_survey) %>%
  # omzetting naar ton per stratum per jaar
  mutate(.epred = .epred / opp_per_staal_m2 * stratum_opp_m2 / 1e6) %>%
  # sommering naar ton voor gewenste groepering in elk jaar
  group_by(jaar, SalZone, .draw) %>%
  summarise(.epred = sum(.epred),
            .groups = "drop_last") %>%
  # berekening modus en interval
  group_by(jaar, SalZone) %>%
  mode_hdci(.epred) %>%
  rename(mzb_tonnage = .epred,
         mzb_tonnage_low = .lower,
         mzb_tonnage_upp = .upper) %>%
  inner_join(benthos_afdw_ps_zonder_survey %>%
               group_by(jaar, SalZone) %>%
               summarize(n = sum(n),
                         n_raai = sum(n_raai),
                         n_spatial = sum(n_spatial),
                         totopp_km2 = sum(stratum_opp_m2) / 1e6,
                         .groups = "drop"),
             by = c("jaar", "SalZone")
             ) %>%
  mutate(methode = "MRP") -> mrp_raaispatial2_salzone
```

```{r mrp-raaispatial-2-ecotoop}
mrp_raaispatial_2 %>%
  add_epred_draws(newdata = benthos_afdw_ps_zonder_survey) %>%
  # omzetting naar ton per stratum per jaar
  mutate(.epred = .epred / opp_per_staal_m2 * stratum_opp_m2 / 1e6) %>%
  # sommering naar ton voor gewenste groepering in elk jaar
  group_by(jaar, ecotoop_werkelijk, .draw) %>%
  summarise(.epred = sum(.epred),
            .groups = "drop_last") %>%
  # berekening modus en interval
  group_by(jaar, ecotoop_werkelijk) %>%
  mode_hdci(.epred) %>%
  rename(mzb_tonnage = .epred,
         mzb_tonnage_low = .lower,
         mzb_tonnage_upp = .upper) %>%
  inner_join(benthos_afdw_ps_zonder_survey %>%
               group_by(jaar, ecotoop_werkelijk) %>%
               summarize(n = sum(n),
                         n_raai = sum(n_raai),
                         n_spatial = sum(n_spatial),
                         totopp_km2 = sum(stratum_opp_m2) / 1e6,
                         .groups = "drop"),
             by = c("jaar", "ecotoop_werkelijk")
             ) %>%
  mutate(methode = "MRP") -> mrp_raaispatial2_ecotoop
```

```{r mrp-raaispatial-2-salzone-ecotoop}
mrp_raaispatial_2 %>%
  add_epred_draws(newdata = benthos_afdw_ps_zonder_survey) %>%
  # omzetting naar ton per stratum per jaar
  mutate(.epred = .epred / opp_per_staal_m2 * stratum_opp_m2 / 1e6) %>%
  # sommering naar ton voor gewenste groepering in elk jaar
  group_by(jaar, SalZone, ecotoop_werkelijk, .draw) %>%
  summarise(.epred = sum(.epred),
            .groups = "drop_last") %>%
  # berekening modus en interval
  group_by(jaar, SalZone, ecotoop_werkelijk) %>%
  mode_hdci(.epred) %>%
  rename(mzb_tonnage = .epred,
         mzb_tonnage_low = .lower,
         mzb_tonnage_upp = .upper) %>%
  inner_join(benthos_afdw_ps_zonder_survey %>%
               group_by(jaar, SalZone, ecotoop_werkelijk) %>%
               summarize(n = sum(n),
                         n_raai = sum(n_raai),
                         n_spatial = sum(n_spatial),
                         totopp_km2 = sum(stratum_opp_m2) / 1e6,
                         .groups = "drop"),
             by = c("jaar", "SalZone", "ecotoop_werkelijk")
             ) %>%
  mutate(methode = "MRP") -> mrp_rsp2_salzone_ecotoop
```

Voor de vergelijking beperken we ons tot enkel de multilevel regressie en poststratificatie methode omdat deze beter toelaat om de raai-survey (preferential sample) te analyseren.

Tabel \@ref(tab:schattingen-raaispatial-jaar) toont nogmaals dat via de raaien in 2019 een veel hogere biomassa wordt ingeschat.
Wanneer we alle data samen gebruiken om de inschatting te maken, bekomen we een schatting die, in het geval van 2018, weinig verschillend is van de spatial survey en, in het geval van 2019, ligt de schatting tussen deze van de raai en spatial survey in.
Het betrouwbaarheidsinterval is wel smaller omwille van de grotere steekproef.
De schatting van 2019 suggereert weer dat de spatial en raai survey sterk van elkaar kunnen verschillen en dat combineren van beide surveys nog steeds een vertekend resultaat kan geven.
De meest waarschijnlijke waarde van 2019 op basis van de spatial survey ligt net iets lager dan de ondergrens van het 95% interval dat we bekomen als we de data van beide surveys samenvoegen.
Tabel \@ref(tab:schattingen-raaispatial-salzone) toont dat dit vooral komt door de "Zone met sterke saliniteitsgradiënt" waar met de raaien een veel hogere biomassa werd ingeschat.

(ref:schattingen-raaispatial-jaar) Schatting van tonnage MZB voor elk jaar met de MRP methode. Twee modellen werden gefit, één waarbij aparte schattingen per type survey bekomen werd en één waarbij het type survey uit het model gelaten werd (= schatting op basis van alle locaties samen ongeacht survey).

```{r schattingen-raaispatial-jaar}
tab <- bind_rows(mrp_raaispatial_jaar,
          mrp_raaispatial2_jaar) %>%
  select(jaar, survey, methode, n, totopp_km2, starts_with("mzb")) %>%
  group_by(jaar) %>%
  mutate(n = as.integer(n)) %>%
  gt(caption = "(ref:schattingen-raaispatial-jaar)") %>%
  fmt_number(columns = where(is.double), decimals = 1)

if (knitr::is_latex_output()) {
  as_latex_with_caption(tab, "schattingen-raaispatial-jaar")
} else {
  tab
}
```

(ref:schattingen-raaispatial-salzone) Schatting van tonnage MZB voor elk jaar in elke saliniteitszone met de MRP methode. Twee modellen werden gefit, één waarbij aparte schattingen per type survey bekomen werd en één waarbij het type survey uit het model gelaten werd (= schatting op basis van alle locaties samen ongeacht survey).

```{r schattingen-raaispatial-salzone}
tab <- bind_rows(mrp_raaispatial_salzone,
          mrp_raaispatial2_salzone) %>%
  select(jaar, SalZone, survey, methode, n, totopp_km2, starts_with("mzb")) %>%
  group_by(jaar, SalZone) %>%
  mutate(n = as.integer(n)) %>%
  gt(caption = "(ref:schattingen-raaispatial-salzone)") %>%
  fmt_number(columns = where(is.double), decimals = 1)

if (knitr::is_latex_output()) {
  as_latex_with_caption(tab, "schattingen-raaispatial-salzone")
} else {
  tab
}
```

```{r schattingen-rsp-ecotoop, eval=FALSE}
tab <- bind_rows(mrp_raaispatial_ecotoop,
          mrp_raaispatial2_ecotoop) %>%
  select(jaar, ecotoop_werkelijk, survey, methode, n, totopp_km2,
         starts_with("mzb")) %>%
  group_by(jaar, ecotoop_werkelijk) %>%
  mutate(n = as.integer(n),
         survey = ifelse(is.na(survey), "beide", survey)) %>%
  gt(caption = "(ref:schattingen-raaispatial-ecotoop)") %>%
  fmt_number(columns = where(is.double), decimals = 1)

if (knitr::is_latex_output()) {
  as_latex_with_caption(tab, "schattingen-raaispatial-ecotoop")
} else {
  tab
}
```

Figuur \@ref(fig:schattingen-raaispatial-ecotoop) zoomt verder in op de verdeling van de biomassa over de ecotopen binnen de saliniteitszones.
In deze figuur zien we dat de hoogste biomassa zich bevindt in de middelhoge slikzones.
Hard substraat heeft meestal de laagste biomassa, maar er zijn uitzondering zoals in het oligohalien waar de locatieschatting hoger ligt dan in de hoge slikzone (in 2018 en 2019) en de lage slikzone (in 2019), die een gelijkaardige oppervlakte heeft.
We zien dat de hoge schatting van 2019 met de raaien in de zone met sterke saliniteitsgradiënt voornamelijk te wijten is aan de zeer hoge schatting in de middelhoge slikzone (het grootste stratum met 2 km²).
De spatial survey heeft echter voor beide jaren in dat geval een gelijkaardige lagere schatting.
Bij de combinatie van raai en spatial wegen de raaien zwaar door voor dit geval.
Omgekeerd, zien we ook situaties waar de spatial survey een beduidend hogere schatting geeft dan de raaien.
Dit is bijvoorbeeld het geval in de zoete delen met korte verblijftijd, met name voor de middelhoge slikzone, mar ook voor de lage en de hoge slikzone en meer uitgesproken in 2019.
Bij zoet met lange verblijftijd komen de schattingen voor 2019 goed overeen, maar in 2018 zijn de schattingen voor vooral de lage slikzone met de spatial survey hoger.
In deze figuur zien we ook duidelijk de grote onzekerheid op het resultaat voor de raaien bij hard substraat omdat we daar weinig of geen data hebben.

(ref:schattingen-raaispatial-ecotoop) Schatting van tonnage MZB voor elk jaar in elke saliniteitszone x ecotooptype combinatie met de MRP methode. Twee modellen werden gefit, één waarbij aparte schattingen per type survey bekomen werd en één waarbij het type survey uit het model gelaten werd (= schatting op basis van alle locaties samen ongeacht survey). De oppervlakte in km² van stratum is weergegeven in de figuur bij survey == "beide".

```{r schattingen-raaispatial-ecotoop, fig.height = 200/25.4, fig.cap = "(ref:schattingen-raaispatial-ecotoop)"}
plotdata <- bind_rows(mrp_rsp_salzone_ecotoop,
          mrp_rsp2_salzone_ecotoop) %>%
  select(jaar, SalZone,
         ecotoop_werkelijk,
         survey,
         totopp_km2,
         starts_with("mzb")) %>%
  mutate(survey = ifelse(is.na(survey), "beide", survey))

textdata <- plotdata %>%
  filter(survey == "beide") %>%
  group_by(jaar,
         survey,
         SalZone) %>%
  summarize(y_positie = max(mzb_tonnage_upp),
            .groups = "drop") %>%
  right_join(plotdata %>%
               filter(survey == "beide") %>%
               mutate(totopp_km2 = round(totopp_km2, 1)),
             by = c("jaar", "survey", "SalZone"))
  

plotdata %>%
  ggplot() +
  geom_pointinterval(aes(x = survey,
                         y = mzb_tonnage,
                         ymin = mzb_tonnage_low,
                         ymax = mzb_tonnage_upp,
                         colour = ecotoop_werkelijk),
                     position = position_dodge(width = 0.6)) +
  geom_text(
    data = textdata,
    aes(x = survey,
        y = y_positie * 1.3,
        label = totopp_km2,
        colour = ecotoop_werkelijk
    ),
    position = position_dodge(width = 0.6),
    size = 2
  ) +
  facet_grid(SalZone ~ jaar, scales = "free_y", 
             labeller = label_wrap_gen(width = 20))
```

(ref:n-raai-spatial) Aantal locaties in de raai en spatial survey in elk van de strata.

```{r n-raai-spatial}
tab <- benthos_afdw_ps_zonder_survey %>%
  select(jaar, SalZone, KRWzone, ecotoop_werkelijk,
         n_locs_raai = n_raai,
         n_locs_spatial = n_spatial) %>%
  group_by(jaar, SalZone) %>%
  gt(caption = "(ref:n-raai-spatial)")

if (knitr::is_latex_output()) {
  as_latex_with_caption(tab, "n-raai-spatial")
} else {
  tab
}
```

## Alternatief meetnetontwerp

### Allocatie van totale steekproefgrootte over strata {#allocatie-strata}

We gebruiken elk jaar apart om de varianties te schatten en gebruiken hiervoor enkel de spatial survey.
Om een variantie of standaarddeviatie goed in te schatten zijn zeer veel data nodig, er is dan ook een grote onzekerheid op deze varianties die we hier echter niet in rekening brengen.

Tabel \@ref(tab:allocatie) geeft het resultaat van de formule voor optimale allocatie van de steekproef over de strata waarbij rekening wordt gehouden met de oppervlakte van elk stratum, de standaarddeviatie en de kosten.
Er is geen merkbaar verschil tussen raai en spatial survey omdat het beperkte effect van de kosten (raai 0.75 versus spatial 1.25 relatieve kosten) teniet wordt gedaan door de grotere relatieve effecten van de stratumgrootte en -heterogeniteit.
Volgens deze resultaten zien we vrij stabiele allocatiepercentages in Zeeschelde I, II en III.
Er zijn echter grote verschillen tussen Getijdedurme en Zeeschelde IV. In 2018 zouden we 30% alloceren naar Getijdedurme en 40% naar Zeeschelde IV, terwijl in 2019 dit respectievelijk 10% en 60% is.
Ook binnen de KRW zones waar er globaal een gelijkaardige allocatie is, kunnen er voor individuele ecotopen toch behoorlijke verschillen zijn (bv. Zeeschelde I, lage slikzone).
Deze grote verschillen kunnen zowel te maken hebben met de grote onzekerheid die zit op de berekening van de ruimtelijke (stratum) varianties als met grote verschillen in jaar-tot-jaar stratum-varianties (o.a. door de dynamiek veroorzaakt door baggerwerken).
Dit toont aan dat het moeilijk is om de formule in de praktijk te gebruiken omdat we op voorhand nooit zeker zullen zijn van de stratum-varianties in een bepaald jaar.
Bovendien is de formule alleen kostenoptimaal voor de schatting van de totale draagkracht van het intertidale systeem.
Aangezien er ook uitspraken gevraagd worden per saliniteitszone, is een overbemonstering van sommige van deze zones ten opzichte van deze allocatie zeker verantwoord.

(ref:allocatie) Allocatie van de steekproefgrootte. Kolommen spatial en raai tonen het resultaat van de allocatieformule uitgedrukt als een relatief percentage in een bepaald jaar.

```{r allocatie}
kost <- werklast %>%
  filter(tidaal == "intertidaal") %>%
  select(campagne, tot_uren_incl_reistijd, aantal_stalen) %>%
  mutate(relkost_per_staal = tot_uren_incl_reistijd / aantal_stalen) %>%
  select(campagne, relkost_per_staal)
  

tab <- benthos_design %>%
  group_by(jaar, KRWzone, ecotoop_werkelijk.benthos) %>%
  summarize(sigma = survey_sd(x = tot_afdw / opp_per_staal_m2),
            stratum_opp_m2 = mean(stratum_opp_m2)) %>%
  expand_grid(kost) %>%
  group_by(jaar, campagne) %>%
  mutate(allocatie = stratum_opp_m2 * sigma / sqrt(relkost_per_staal),
         allocatie = allocatie / sum(allocatie) * 100) %>%
  select(jaar, campagne, KRWzone,
         ecotoop = ecotoop_werkelijk.benthos,
         allocatie) %>%
  pivot_wider(names_from = c(jaar, campagne),
              values_from = c(allocatie)) %>%
  gt(groupname_col = "KRWzone",
     caption = "(ref:allocatie)") %>%
  fmt_number(columns = where(is.double),
             decimals = 1) %>%
  summary_rows(groups = TRUE,
               columns = contains(c("raai", "spatial")),
               fns = list(Totaal = ~sum(.)),
               decimals = 1) %>%
  grand_summary_rows(columns = contains(c("raai", "spatial")),
                     fns = list(Eindtotaal = ~sum(.)),
                     decimals = 0)

if (knitr::is_latex_output()) {
  as_latex_with_caption(tab, "allocatie")
} else {
  tab
}
```

### Afweging meer locaties versus nauwkeuriger bemonsteren {#bemonsteringsinspanning}

Om de afweging te maken tussen meer locaties bemonsteren versus per locatie een hogere bemonsteringsinspanning te doen, hebben we informatie nodig over de kosten geassocieerd met de selectie van de locaties, de bemonstering ter plaatse en de naverwerking in het labo.
Daarnaast hebben we ook informatie nodig die toelaat om de totale variantie op te splitsen in variantie die het gevolg is van het trekken van een steekproef en variantie die het gevolg is van ter plaatse een bemonstering uit te voeren en de naverwerking in het labo.
We hebben echter geen informatie die toelaat om deze opdeling in variantiecomponenten te maken.

Tabel \@ref(tab:kosten-selectie-bemonstering) toont dat voor de raaien de bemonsteringskost `r round(0.8 / 7.2 * 100)`% bedraagt, de selectiekost `r round(1.2 / 7.2 * 100)`% bedraagt en de labokost `r round(5.2 / 7.2 * 100)`% bedraagt.
Voor de spatial survey is dit respectievelijk `r round(1.2 / 8.4 * 100)`%, `r round(2.0 / 8.4 * 100)`% en `r round(5.2 / 8.4 * 100)`%.
In deze berekening zitten echter alleen de kostenposten die kunnen uitgedrukt worden in gewerkte uren.
Zaken zoals materiaalkosten zijn niet inbegrepen en dragen bij aan zowel de bemonsteringskost (staalnamemateriaal, bewaarmiddel, ...), labokosten (labomaterialen, ...) als de selectiekost (verplaatsingskosten, GPS, ...).
Wanneer dit variabele kosten betreft, moeten deze worden toegevoegd om tot een betere inschatting van de verhouding tussen bemonsteringskost en selectiekost te komen.
Vaste kosten zijn niet van belang voor de optimalisatie van de bemonstering.

(ref:kosten-selectie-bemonstering) Overzicht van bemonsteringskosten, labokosten en selectiekosten (uitgedrukt in uren per staal; dus exclusief verbruikskosten).

```{r kosten-selectie-bemonstering}
a <- kosten %>%
  filter(!str_detect(kostenpost, "subtidaal"),
         taakgroep %in% c("voorbereiding", "labowerk"))

a <- a %>%
  mutate(survey = "raai") %>%
  bind_rows(a %>% 
              mutate(survey = "spatial"))


tab <- kosten %>%
  filter(!str_detect(kostenpost, "subtidaal"),
         !(taakgroep %in% c("voorbereiding", "labowerk"))) %>%
  mutate(survey = ifelse(taakgroep == "veldwerk_raai",
                                "raai", "spatial"),
         taakgroep = ifelse(str_detect(taakgroep, "veldwerk"),
                            "veldwerk", taakgroep)) %>%
  bind_rows(a) %>%
  pivot_wider(names_from = survey,
              values_from = uren_per_staal_gelogd) %>%
  mutate(kostenallocatie = ifelse(taakgroep == "labowerk",
                                  "labokosten",
                                  kostenallocatie)) %>%
  select(-taakgroep) %>%
  group_by(kostenallocatie) %>%
  gt(caption = "(ref:kosten-selectie-bemonstering)") %>%
  fmt_number(columns = where(is.double), decimals = 1) %>%
  fmt_missing(columns = everything()) %>%
  summary_rows(groups = TRUE,
               columns = where(is.double),
               fns = list(Totaal = ~sum(., na.rm = TRUE)),
               decimals = 1)

if (knitr::is_latex_output()) {
  as_latex_with_caption(tab, "kosten-selectie-bemonstering")
} else {
  tab
}
```

### Steekproeftrekkingstrategieën

```{r steekproef, cache=TRUE}
# ook hard substraat weglaten in veronderstelling dat het weinig bijdraagt
rast <- raster::raster(ecotoop, resolution = c(2, 2))
strata <- ecotoop %>%
    filter(!str_detect(ecotoop_werkelijk, "subtidaal"),
           !str_detect(ecotoop_werkelijk, "hard substraat"),
           Naam %in% c("Zeeschelde", "Durme", "Rupel")) %>%
    st_make_valid() %>%
    group_by(ecotoop_werkelijk, KRWzone) %>%
    summarize(.groups = "drop")

raster_ecotoop <- exactextractr::coverage_fraction(
  x = rast,
  y = strata,
  crop = TRUE
)

strata_df <- strata %>%
  st_drop_geometry() %>%
  mutate(stratum = paste(ecotoop_werkelijk, KRWzone, sep = "_"))

for (i in seq_len(length(raster_ecotoop))) {
  raster_ecotoop[[i]] <- rast(raster_ecotoop[[i]])
  raster_ecotoop[[i]][raster_ecotoop[[i]] == 0] <- NA
  names(raster_ecotoop[[i]]) <- strata_df$stratum[i]
}
```

```{r eval=FALSE}
for (i in seq_len(length(raster_ecotoop))) {
  plot(raster_ecotoop[[i]])
}

# bereken allocatie van totale steekproefgrootte over volgens de formule
# (variantie en kosten)

# trekking ruimtelijk gebalanceerd in elk stratum
# jaarlijkse steekproefgrootte x 2 of x 3
# grts-achtige trekking zodat punten in volgorde geselecteerd

# bv 1/2 of 2/3 van de punten beschouwen als permanent vaste punten,
# overige als jaarlijks random

# of alle punten in de populatie een random volgnummer geven (master sample)
# jaar 1: set a, b, c; jaar 2: set b, c, d; jaar 3: set c, d, e; etc.
# zodat in een willekeurig jaar een derde van de punten gedurende drie jaar
# wordt opgevolgd


```

## Biomassa - hoogte {#biomassa-hoogte-relatie}

Er lijkt een piek te zijn in de biomassa bij gemiddelde hoogte in het intertidaal.
Dit is zowel in de spatial survey als de raai-survey te zien (Figuur \@ref(fig:biomassa-hoogte)).
In principe kan dan de hoogtevariabele (die bij benadering overal gekend is via DTM beeld) gebruikt worden om de schattingen te verbeteren via design-based regressieschatters (**kan** leiden tot iets smallere betrouwbaarheidsintervallen).

(ref:biomassa-hoogte) Biomassa in functie van hoogteligging in het intertidaal voor beide survey-types.

```{r biomassa-hoogte, fig.cap="(ref:biomassa-hoogte)", message=FALSE}
benthos_afdw_zs_durme_rupel %>%
  filter(tidaal == "intertidaal",
         Z >= 0) %>%
  ggplot(aes(x = Z, y = tot_afdw, colour = jaar)) +
  geom_point() +
  geom_smooth() +
  scale_y_sqrt() +
  facet_wrap(tidaal~survey, scales = "free") +
  labs(x = "Hoogte (m)",
       y = "Biomassa (g)")
```

<!--chapter:end:03_resultaten.Rmd-->

---
bibliography: moneos.bib
---

# Discussie

## Onzekerheid op de totale MZB biomassa

Hoe groot is de onzekerheid op de totale MZB biomassa?
Om deze vraag te beantwoorden kijken we vooral naar de spatial survey campagnes, aangezien deze specifiek hiervoor ontworpen zijn.
Door de random gestratificeerde steekproef zal het betrouwbaarheidsinterval met 95% zekerheid het werkelijke tonnage bevatten.
Op niveau van het volledige systeem komen de breedtes van de betrouwbaarheidsintervallen vrij goed overeen tussen de verschillende methodes.
Het gaat om een relatieve foutenmarge tussen 34% en 39% (halve breedte van het betrouwbaarheidsinterval gedeeld door de locatieschatter).
Dit is een aanvaardbare foutenmarge om de vergelijking te maken met de doelstelling van 30 ton.

Er is een omgekeerd evenredig verband tussen de vierkantswortel van de steekproefgrootte ($n$) en de foutenmarge (foutenmarge $\propto \frac{1}{\sqrt{n}}$).
Dat wil zeggen dat een vergroting van de steekproefgrootte pas een substantieel effect zal hebben bij een heel sterke toename van de steekproefgrootte (x 4 geeft een halvering van de foutenmarge, zie Figuur \@ref(fig:foutenmargeVsN)).
Om de onzekerheid te verkleinen kan men daarom beter over andere opties nadenken.
Eén van deze opties is bijvoorbeeld om de kans op nulwaarnemingen (geen MZB) te verkleinen door de hoeveelheid staal per locatie te vergroten - eventueel via een mengstaal.
Een andere optie is om de besluitvorming niet te baseren op één jaar gegevens, maar te werken met een lopend gemiddelde van de afgelopen twee of drie jaar.
De steekproefgrootte vergroten zal pas een substantieel effect hebben bij een heel sterke toename van de steekproefgrootte (x 4 geeft een halvering van de foutenmarge).

(ref:foutenmargeVsN) Foutenmarge als functie van de steekproefgrootte. De rode punten geven de huidige steekproefgrootte en foutenmarge weer. De rode lijnen illustreren de omgekeerd evenredige relatie tussen de foutenmarge en de vierkantswortel van de steekproefgrootte; de foutenmarge halveert wanneer de steekgroef 4 keer groter is.

```{r foutenmargeVsN, fig.cap = "(ref:foutenmargeVsN)"}
n2018 <- 50:1000
foutenmarge2018 <- 34 * 1 / (sqrt(n2018 / 112))
n2019 <- 50:1000
foutenmarge2019 <- 39 * 1 / (sqrt(n2019 / 113))
df <- rbind(cbind(n2018, foutenmarge2018, rep(2018, length(n2018))),
            cbind(n2019, foutenmarge2019, rep(2019, length(n2019)))) %>% 
  as.data.frame() %>%
  mutate(V3 = as.factor(V3))
colnames(df) <- c('n', 'foutenmarge', 'jaar')
ggplot() + geom_line(data = df, aes(x = n, y = foutenmarge, color = jaar)) + 
  geom_point(aes(x = c(112, 113), y = c(34,39)), color = "red") + 
  geom_segment(aes(x = 112, xend = 112 * 4, y = 34, yend = 34), 
               arrow = arrow(length = unit(0.5, "cm")), 
               color = "red", lty = "dashed") +
  geom_segment(aes(x = 112 * 4, xend = 112 * 4, y = 34, yend = 34 / 2), 
               arrow = arrow(length = unit(0.5, "cm")), 
               color = "red", lty = "dashed") +
  geom_text(aes(x = 250, y = 36,  label = "* 4"), color = "red") + 
  geom_text(aes(x = 117 * 4, y = 25,  label = "/ 2"), color = "red") + 
  theme_bw() + 
  xlab('Aantal stalen (n)') +
  ylab('Foutenmarge (%)') +
  xlim(0, 1001) + ylim(0, 60)
```

Indien we per saliniteitszone naar de betrouwbaarheidsintervallen kijken, zien we uiteraard een minder gunstig beeld (want kleinere steekproefgrootte).
In dat geval vinden we relatieve foutenmarges tussen 46% en 157%.

Naast vergroten van de steekproefgrootte, zijn er ook andere opties om de precisie te vergroten.
We bespreken eerst de allocatie van de steekproefgrootte over de strata, daarna wijzigen van de bemonsteringsinspanning en tot slot mogelijkheden in verband met de analyse van de data.

### Allocatie van steekproefgrootte over de strata

Een eerste optie die we bekeken hebben was nagaan of er een betere allocatie van de steekproef over de verschillende strata mogelijk was (Sectie \@ref(allocatie-strata)).
Hieruit bleek dat het verschil in veldwerkinspanning tussen de raaien en de spatial survey niet groot is ten opzichte van de effecten van variabiliteit en oppervlakte van elk stratum.
Hierdoor was de allocatie voor aantal locaties over de verschillende strata dezelfde voor raaien en spatial.
Belangrijker is echter dat er vrij grote verschillen in optimale allocatie tussen de jaren aan het licht kwamen die te maken hadden met zowel onzekerheid over de stratum-varianties als jaar-tot-jaar veranderingen in de stratum-varianties door dynamiek van onder andere slibruimingen.
Het feit dat deze optimale allocaties van jaar tot jaar kunnen verschillen en dat we op voorhand niet weten hoe de dynamiek zal veranderen, maakt dat we niet 100% kunnen vertrouwen op deze "optimale" allocatie en ze in de praktijk niet bruikbaar is.
We besluiten dan ook dat de huidige manier van alloceren best aangehouden wordt.

### Selectie, bemonstering en naverwerking

Een tweede mogelijkheid is wijzigingen maken aan de verdeling van de inspanning tussen selectie, bemonstering en naverwerking van de stalen in het labo (Sectie \@ref(bemonsteringsinspanning)).
We hebben echter maar gedeeltelijk zicht op de benodigde informatie (kosten en varianties) om hier volledig onderbouwde uitspraken over te doen.
De kosten (weliswaar onvolledig) gaven aan dat de bemonsteringskost de kleinste fractie is van de kosten (10% à 15%), gevolgd door de selectiekost (15% à 25%).
Het resterende en grootste deel zijn de labokosten waarbij de triage van de soorten het grootste aandeel inneemt (iets meer dan 50%).
De triage en determinatie zijn strikt genomen niet noodzakelijk voor de biomassabepaling, maar wel voor andere doeleinden.
Als we triage en determinatie buiten beschouwing laten, is de verdeling evenwichtiger (voor de spatial survey ruwweg 25% bemonstering, 45% selectie, 30% labowerk).

Een groter aantal stalen verwerken kan misschien haalbaar zijn indien de stalen op een andere manier verwerkt worden.
Momenteel wordt het volledige bodemstaal bewaard door toevoeging van bewaarmiddel.
Een alternatieve methode is om de stalen ter plaatse te zeven met Scheldewater in plaats van achteraf in het labo (mond. med. Frank Van de Meutter).

### Gebruik maken van een mengstaal?

In plaats van meer locaties ($n$) te bemonsteren, is het misschien beter om meer inspanning ter plaatse te doen.
In wat volgt veronderstellen we dat dezelfde diameter van bodemboor wordt gebruikt bij het nemen van meerdere bodemstalen op eenzelfde locatie.
Verhogen van het aantal bodemstalen zal dus de totale bemonsterde bodemoppervlakte op een locatie evenredig verhogen.
Om dit idee te verkennen gebruiken we formules voor een tweestapssteekproef.
We zullen echter aantonen dat de bodemstalen per locatie niet individueel hoeven geanalyseerd te worden maar dat - onder bepaalde aannames - ze kunnen worden samengevoegd tot één mengstaal.
In de praktijk betekent dit dus dat een hoger bodemvolume zal geanalyseerd worden, maar het blijft één (meng)staal per locatie.
Verder veronderstellen we dat we elke locatie in het gehele gebied kunnen beschouwen als een discrete eenheid ($n$ locaties uit $N$ mogelijke locaties in het gebied) die opgedeeld kan worden in discrete subeenheden.
Hierbij nemen we de oppervlakte van de bodemboor als eenheid van een subeenheid en we stellen deze gelijk aan 1.
Verder veronderstellen we dat elke locatie dezelfde grootte heeft ($M$ subeenheden) en dat er binnen elke locatie evenveel bodemstalen worden genomen ($m$ subeenheden met $m \leq M$).
De huidige MZB SPATIAL survey kunnen we dus beschouwen als het geval waarbij $m = M = 1$.
Indien er een grotere bodemoppervlakte per locatie wordt bemonsterd (door bijvoorbeeld een mengstaal te nemen), krijg je een soort smoother-effect: de schatter op die locatie is preciezer.
Afhankelijk hoe groot je een locatie neemt $M$ en hoeveel subsamples $m$ je neemt per locatie, zal de steekproeffout wijzigen afhankelijk van de varianties tussen en binnen locaties (zie Figuur \@ref(fig:twostage) en \@ref(fig:sample-variances)).
De schatter van variantie op het totaal kan als volgt berekend worden [@cochran1977a]:

$$\hat{\sigma}^2_{\hat{y}} = \frac{N^2}{n}(1-f_1)\hat{s}^2_{1y} + \frac{N^2}{n}\frac{M^2}{m}f_1(1-f_2)\bar{\hat{s}^2_{2y}}$$

Voor de variantie op het gemiddelde moeten we de linkse term delen door $N^2$ en de rechtse term delen door $N^2M^2$.
De formule laat zien dat de totale variantie uiteenvalt in een som van variantie tussen de locaties (linkse term) en gemiddelde variantie binnen de locaties (rechtse term).
Hierbij is:

```{=latex}
\begin{align*}
\hat{s}^2_{1y} &= \frac{1}{n-1}\sum_{i=1}^n(\bar{y}_i-\bar{y})^2\\
\bar{\hat{s}^2_{2y}} &= \frac{1}{n}\sum_{i=1}^n\sum_{j=1}^m\frac{1}{m-1}(y_{ij}-\bar{y}_i)^2\\
f_1 &= \frac{n}{N}\\
f_2 &= \frac{m}{M}\\
\bar{y}_i &= \frac{1}{m}\sum_{j=1}^my_{ij}\\
\bar{y} &= \frac{1}{n}\frac{1}{m}\sum_{i=1}^n\sum_{j=1}^my_{ij}
\end{align*}
```

Wanneer $\frac{n}{N}$ verwaarloosbaar is (wat het geval is voor MZB), dan vereenvoudigt de formule tot:

$$\hat{\sigma}^2_{\hat{y}} = \frac{N^2}{n}\hat{s}^2_{1y} = \frac{N^2}{n}\frac{1}{n-1}\sum_{i=1}^n(\bar{y}_i-\bar{y})^2$$ Dit betekent dat we de individuele bodemstalen niet nodig hebben om een onvertekende schatter te bekomen, maar een mengstaal kunnen nemen per locatie (= gemiddelde van de individuele bodemstalen op een locatie = $\bar{y}_i$).

(ref:twostage) Simulatie van een gebied waarbinnen een vleksgewijze verspreiding van MZB is (in feite voor te stellen als een zich in alle richtingen oneindig uitgestrekt gebied met gelijkaardig ruimtelijk patroon: vergelijk rode zone met ruimer gebied errond). De simulatie gaat uit van 30% bedekking van MZB (en dus biomassa als we veronderstellen dat de biomassa homogeen verdeeld is waar het voorkomt). De zwarte vierkanten in de linkerbenedenhoek zijn de verschillende groottes van proefvlakken (locaties) die we doorgerekend hebben.

```{r landschap}
bedekking <- 0.3
landschap <- genereer_landschap(bedekking_vector = bedekking, 
                                verspreiding = "geclusterd",
                                opp_ha = 122,
                                mask = TRUE)
# 122 ha om voldoende extra buffer rond centraal deel van 50 ha te hebben
# om randeffecten te vermijden
# met mask = TRUE krijgen we een binair rasterlandschap
landschap <- landschap$geclusterd[[1]]
```

```{r twostage-calculations, cache=TRUE, autodep=TRUE}
varianties_df <- expand_grid(
  odd_nrows = c(1, 3, 5, 7, 9, 11, 33, 51, 71, 99, 121, 149),
  m = c(1, 2, 4, 8)) %>%
  filter(m <= odd_nrows ^ 2) %>%
  group_by(odd_nrows, m) %>%
  summarise(
    twostage(spatial_distribution = landschap, m = m, nrow = odd_nrows),
    .groups = "drop") %>%
  pivot_longer(cols = c(var_1y_pop, mean_var_2y_pop, som_var_pop),
               names_to = "variantiecomponent",
               values_to = "waarde")
```

```{r twostage, out.width="100%", fig.cap="(ref:twostage)"}
makesquare <- function(nrow) {
  data.frame(
    id = nrow^2,
      x = c(0, 0, nrow, nrow, 0),
      y = c(0, nrow, nrow, 0, 0)
      )
}

squares <- c(1, 3, 5, 7, 9, 11, 33, 51, 71, 99, 121, 149) %>%
  as_tibble() %>%
  nest_by(value) %>%
  mutate(square = map(value, makesquare)) %>%
  unnest(square) %>%
  ungroup() %>%
  select(id, x, y)

p1 <- as.data.frame(landschap) %>%
  ggplot(aes(x = x, y = y)) +
  geom_raster() + 
  coord_fixed() +
  geom_polygon(
    data = data.frame(
      x = c(0, 0, 707, 707, 0) + 200,
      y = c(0, 707, 707, 0, 0) + 200
      ),
    colour = "red",
    alpha = 0) +
  geom_polygon(
    data = squares,
    aes(group = id),
    colour = "black",
    alpha = 0.1)

p1
```

(ref:sample-variances) Illustratie van effect van grootte van locatie (uitgedrukt in termen van $M$ subeenheden), aantal locaties ($n$) en aantal substalen ($m$) op variantiecomponenten. De figuur geeft de variantiecomponenten en de som van beide in functie van de oppervlakte van een locatie (het aantal subunits in deze locatie wordt uitgedrukt door $M$ in termen van de oppervlakte van één bodemstaal $m$) en dit voor verschillende aantallen locaties ($n$) en aantal bodemstalen binnen een locatie ($m$). Zowel $m$ als $M$ zijn dus te begrijpen als aantallen of als oppervlaktes. In het geval dat $m = M$ is, is de totale variantie gelijk aan de variantie tussen locaties. Je kan dit geval aflezen uit de deelfiguur $m = 1$ door enkel te kijken naar de lijn die de variantie tussen locaties aangeeft (de waarde van $m = M$ lees je dan af van de x-as). De x-as staat in een logaritmische schaal om beter de verschillen bij kleine waarden weer te geven.

```{r sample-variances, fig.cap = "(ref:sample-variances)"}
varianties_df %>%
  expand_grid(n = c(25, 100)) %>%
  pivot_wider(names_from = variantiecomponent, values_from = waarde) %>%
  mutate(
    `var tussen locaties` = 1 / n * var_1y_pop,
    `var binnen locaties` = 1 / (n * m) * mean_var_2y_pop, 
    `som van varianties` =  `var tussen locaties` + `var binnen locaties`) %>%
  pivot_longer(cols = c(`var tussen locaties`, `var binnen locaties`,
                        `som van varianties`),
               values_to = "waarde", names_to = "component") %>%
  ggplot(aes(x = M, y = waarde)) +
  geom_line(aes(colour = component)) + 
  geom_rug(sides = "b") +
  scale_x_log10("oppervlakte van locatie (opp. eenheid is oppervlakte van één bodemstaal)") + 
  scale_y_continuous("variantie") +
  facet_grid(n~m, labeller = label_both, scales = "free_y") +
  theme(aspect.ratio = 1,
        legend.position = "bottom")
```

Figuur \@ref(fig:sample-variances) laat zien dat het - voor de hypothetische verdeling van MZB biomassa in Figuur \@ref(fig:twostage) - wellicht zal lonen om $m = 4$ bodemstalen te nemen in $n = 25$ locaties van 100 x 100 oppervlakte-eenheden omdat deze een vergelijkbare totale variantie heeft als $n = 100$ locaties van 1 oppervlakte-eenheid bemonsteren met $m = 1$.

Momenteel is locatie gedefinieerd als een oppervlakte $M$ van `r round(opp_per_staal_m2 * 1e4)` cm² waarvan we de volledige oppervlakte bemonsteren met één staal ($m = M = 1$ in termen van oppervlakte van één staal).
We zien in de figuur dan dat de totale variabiliteit gelijk is aan de variabiliteit tussen locaties (de tweestapssteekproef vereenvoudigt dan tot een enkelvoudige aselecte steekproef).
Hoe groter de locatie, hoe kleiner de variantie tussen locaties wordt.
Stel bijvoorbeeld dat we een locatie expliciet definiëren als 1 m x 1 m.
De beste inschatting van biomassa op deze locatie zullen we krijgen indien we de volledige oppervlakte afgraven, zeven, drogen en het asvrij drooggewicht bepalen.
Dit vergt echter een te grote inspanning.
Dus kunnen we werken via subsampling en meerdere bodemstalen per locatie nemen.
Dit zal een benadering geven van de biomassa binnen de locatie van 1 m x 1 m.
Hoe goed deze benadering is zal er van afhangen hoe homogeen de biomassa lokaal verdeeld is (variabiliteit binnen locaties).
Een betere benadering kunnen we altijd bekomen door het aantal bodemstalen binnen een locatie op te drijven en ze te poolen (een mengstaal maken; de substalen apart houden zou de kosten sterk opdrijven).
We kunnen dus met verschillende variabelen spelen om een zo goed mogelijke kostenbatenbalans te krijgen voor de steekproef: het aantal locaties, de oppervlakte van een locatie, het aantal substalen per locatie en de oppervlakte per (sub)staal.
Voor de MZB survey ontbreekt er echter nog cruciale informatie om zo'n afweging te kunnen maken.
Hiervoor is een pilootstudie nodig waarbij bijvoorbeeld voor twee verschillende groottes van locaties ($1 m²$ en $10 m²$) op $n = 10$ er $m = 8$ substalen worden genomen.
Deze substalen worden in de pilootstudie *niet of slechts gedeeltelijk* samengevoegd tot een mengstaal (om ook de gevallen $m < 8$ in te kunnen schatten).
Om ze gedeeltelijk samen te voegen kan men per locatie twee bodemstalen apart analyseren, en twee mengstalen maken.
Eén van twee bodemstalen en één van vier bodemstalen (dus $8 = 1 + 1 + 2 + 4$).
De kosten hiervan dienen goed bijgehouden te worden op zo'n manier dat ze kunnen toegewezen worden aan de selectie van locaties versus de selectie binnen locaties.
Vermits hoogteligging belangrijke verschuivingen in MZB kan veroorzaken is het nodig om de locaties een vorm te geven waarbij er geen (belangrijke) gradïent in hoogte is binnen de locatie.
Voor de $10m²$ locatie zal dit wellicht betekenen dat dit een langgerekte zone is van $1m \times 10m$ die met de lange zijde parallel aan de rivieras gelegen is.

### Rapportage aanpassen?

Ook zonder aanpassingen aan het steekproefontwerp zijn er mogelijkheden om met deze relatief brede foutenmarges om te gaan.
Indien bijvoorbeeld de besluitvorming niet op één jaar gegevens gebaseerd wordt, maar op basis van een lopend gemiddelde van de afgelopen twee of drie jaar.
Daardoor kan er gerapporteerd worden op basis van meer gegevens en zal de foutenvlag kleiner zijn.

## Gebruik van raaien om totale MZB biomassa te schatten

Kan een betrouwbare schatting van de totale MZB biomassa bekomen worden op basis van de raaien of (een deel van) de raaien aangevuld met random gestratificeerde steekproef?

Bij de vergelijking van raaien met spatial survey was vooral het jaar 2019 opvallend verschillend en dan met name veroorzaakt door een veel groter biomassa-aandeel ingeschat door de raaien in middelhoge slikzone van zones met een sterke saliniteitsgradiënt (wat meteen ook de grootste oppervlakte is in het systeem).
De raaien liggen op plaatsen met mooi ontwikkeld slik terwijl bij de spatial survey in elk stratum een vergelijkbaar aantal locaties getrokken worden en er ook locaties getrokken worden met breuksteen.

Met de informatie die we nu hebben, kunnen de raaien niet gebruikt worden om een betrouwbare inschatting te maken.
De poststratificatie die we nu toepassen is enkel gebaseerd op de originele stratificatie door KRW zones in combinatie met ecotopen.
Dit betekent dat met enkel de raaien we veel kans hebben op een overschatting van de werkelijke biomassa in het systeem, omdat de raaien gelegen zijn in de best ontwikkelde zones terwijl we de steekproefschattingen aandikken met de volledige stratum-oppervlaktes (ongeacht of deze goed of slecht ontwikkeld zijn) om tot totalen te komen voor de volledige doelpopulatie.
Aangezien er geen duidelijke ruimtelijke afbakening is van wat de ecologisch beste gebieden zijn, kunnen we deze ontbrekende informatie niet gebruiken om tot betere poststratificatie correcties te komen van de raaien.
Wat er nodig is, is dus een gekende of gemodelleerde kaart of databron die een duidelijke relatie vertoont met "ecologisch beste gebieden".
Dit is echter een beetje een *Catch-22* probleem, want het zijn net de MZB gegevens die men dacht te gebruiken om te bepalen welke gebieden ecologisch best ontwikkeld zijn.
Niettemin kan gewoon op basis van een aantal ecologische overwegingen een operationele definitie bepaald worden die via een GIS-analyse kan afgebakend worden (pers. med. Frank van De Meutter):

-   ononderbroken intertidale zone (niet onderbroken door hard substraat)
-   geen extreem steile gradiënt van laag naar hoge slikzone
-   voldoende brede zone (exacte breedte te bepalen, mogelijk afhankelijk van Saliniteitszone)
-   over een voldoende aaneengesloten lengte aanwezig (exacte lengte te bepalen, mogelijk afhankelijk van Saliniteitszone)

Zo'n kaart kan vervolgens ingedeeld worden in strata (lage, gemiddelde, hoge potenties) en gebruikt worden in de poststratificatiestap samen met de andere stratificatievariabelen.
Indien er onzekerheid geassocieerd is met zulke kaart, dient bovendien deze onzekerheid via foutenpropagatie mee doorgerekend te worden.
Mogelijk kan dit toelaten om een meer getrouwe afspiegeling te maken van het aandeel biomassa bekomen via de raaien in de doelpopulatie.
Los daarvan, zullen met enkel de raaien veel poststratificatiecellen leeg zijn of weinig data bevatten.
Een aanvulling met extra, aselecte gegevens blijft dus zeker nodig.

## Is een sample in ecologisch oninteressante gebieden nodig?

Voor het stratified random sample moeten veel ecologisch gezien oninteressante gebieden meegenomen worden, waar vogels nauwelijks of niet foerageren (MZB als voedselbron).
Zijn deze gebieden dan nodig voor de berekening van de draagkracht van de rivier?

Vooraleer we hierop antwoorden, is het zinvol een onderscheid te maken tussen de slikzones en de zones met hard substraat.
Binnen de slikzones zijn er verschillen in ecologische kwaliteit van de gebieden, maar bij de zones met hard substraat is de hoeveelheid slik (of de afwezigheid ervan) de primaire beperkende factor.

Bij de berekening van de locatieschatters en de betrouwbaarheidsintervallen wordt wellicht onvoldoende rekening gehouden met de manier waarop hard substraat gesampled wordt.
Als er in praktijk een random punt is met breuksteen, wordt het punt verlegd naar een plaats nabij waar er toch wat slik ligt.
Dit betekent dat de doelpopulatie voor dat stratum in feite slaat op enkel de beperkte oppervlakte aan slik die nog aanwezig is tussen de harde substraten, terwijl bij de berekening de volledige oppervlakte wordt meegeteld.
De biomassabijdrage voor het hard substraat bedraagt, op deze manier berekend, iets meer dan 5% van de totale biomassa (terwijl de oppervlakte hard substraat 1.7 km² beslaat ten opzichte van een totaal van 8.4 km² of 20%) en heeft dus weinig invloed op het uiteindelijke resultaat (maar misschien net nog niet verwaarloosbaar).
Deze manier van berekenen geeft echter een overschatting (vertekening) van de biomassa MZB in hard substraat (op het hard substraat zelf is de biomassa per definitie 0).
Indien men kan inschatten wat het oppervlakte-aandeel is van hard substraat waar er effectief nog slik aanwezig is, kan men de bijdrage van hard substraat opnieuw berekenen.
Als daaruit zou blijken dat deze biomassa-bijdrage heel klein is ten opzichte van het totaal (ook per saliniteitszone), dan is het wellicht beter om dit stratum volledig uit de doelpopulatie te halen en niet meer te samplen.
Nog een andere manier om tot correcte schatting voor hard substraat te komen is om de random punten met breuksteen *niet* te verleggen.
Men dient dan enkel te noteren dat het breuksteen is en geen staal van MZB genomen kon worden (de biomassa is dan 0 voor die locatie).

Wat de overige slikzones betreft (laag, middelhoog en hoog), blijft het nodig om in elk van deze strata locaties te bemonsteren opdat een goed gemiddeld beeld kan bekomen worden voor de berekening van de draagkracht van de rivier.

## Is een alternatieve steekproeftrekking een optie?

Tot slot bespreken we nog enkele mogelijkheden om de steekproeftrekking aan te passen op zo'n manier dat we enerzijds een representatief beeld kunnen krijgen van de draagkracht van het systeem en anderzijds toelaten om vragen te beantwoorden die men beoogt met het systeem van raaien (zoals effecten van sedimenthoogteveranderingen op MZB biomassa en samenstelling).

```{r delta-z-afdw, eval=FALSE}
benthos_raai_design %>%
  group_by(ecotoop_werkelijk.benthos, SalZone, staal, staalcode) %>%
  summarise(
    delta_tot_afdw =
      last(tot_afdw, order_by = jaar) - first(tot_afdw, order_by = jaar),
    delta_z = 
      last(Z, order_by = jaar) - first(Z, order_by = jaar)
  ) %>%
  ggplot() + 
  geom_point(aes(x = delta_z, y = delta_tot_afdw)) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  facet_grid(ecotoop_werkelijk.benthos ~ SalZone)
```

We bespreken twee alternatieven: een eerste waarbij afzonderlijke locaties getrokken worden en een tweede waarbij locaties langsheen raaien getrokken worden.
In beide gevallen gaan we uit van $n_j$ locaties die in een bepaald jaar $j$ opgevolgd worden, waarbij $n_j$ van dezelfde grootte-orde is als het huidig aantal locaties dat in het intertidaal van Zeeschelde, Rupel en Getijdedurme jaarlijks wordt opgevolgd in één van beide survey-types (dus ongeveer een 150 locaties).

Voor een ruimtelijk gebalanceerde trekking van locaties in elk stratum, kunnen we als volgt werken:

-   leg het steekproefkader vast (hard substraat eventueel weglaten)

-   definieer de strata op basis van KRW zone en ecotooptype, eventueel aangevuld met stratificatie volgens ecologische potentie (in termen van MZB).
    Eventueel kan een hoger aandeel locaties toegewezen worden aan strata met hoger ecologisch potentieel.
    Eventueel kan ecotooptype niet gebruikt worden als stratificatievariabele op voorwaarde dat dan hoogte naast ligging (x en y coördinaat) meegenomen wordt als één van de variabelen waarover een goede spreiding van de locaties bekomen moet worden.

-   bepaal de steekproefgrootte per stratum $n_{jk}$

-   trek een overmaat aan locaties ($n_{excess} >> n_{j}$) uit het gehele steekproefkader met behulp van een algoritme dat zorgt voor een ruimtelijk goede spreiding van de locaties en waarbij een volgorde wordt toegekend aan de locaties (rangnummers).
    Elke subset van locaties geordend volgens deze volgorde is opnieuw ruimtelijk goed gespreid.
    Technisch is dit mogelijk met generalized random tessalation sampling (GRTS), balanced acceptance sampling (BAS), of local pivotal method (LPM).

-   maak gebruik van de rangnummers om per stratum een deel locaties één of meerdere jaren of permanent op te volgen (het aantal jaren dat dezelfde locaties opgevolgd worden kan mogelijk gemotiveerd worden door de traagheid van het systeem na een verstoring zoals een slibruiming, i.e. hoeveel jaren duurt het na een slibruiming voor er zich terug een stabiel evenwicht instelt in de samenstelling en relatieve abundanties van de MZB gemeenschap) [@breidt1999a; @urquhart1999]:

    -   **voorbeeld 1 (supplemented panel design)** jaar 1: set a en b; jaar 2: set a en c; jaar 3: set a en d; etc. zodat set a permanent wordt opgevolgd (bv de helft van $n_{jk}$) en de andere punten jaarlijks een nieuwe set zijn

    -   **voorbeeld 2 (rotating panel design)** jaar 1: set a, b, c; jaar 2: set b, c, d; jaar 3: set c, d, e; etc. met elke set een derde van $n_{jk}$ locaties, zodat voor analyse voor een derde van de punten data van de afgelopen drie jaar beschikbaar is, voor een derde data van de afgelopen twee jaar en een derde enkel van het huidige jaar.
        Deze strategie leent zich dan misschien best voor een rapportage op basis van een driejaarlijks lopend gemiddelde.

Een alternatief opzet waarbij gewerkt wordt met enkel locaties langsheen raaien is ook mogelijk.
Een strikt verschil met de huidige raai-aanpak, is dan wel dat deze raaien aselect getrokken zijn.
Gelijkaardig aan bovenstaande aanpak, is een raai-gebaseerde, ruimtelijk gebalanceerde aselecte trekking ook mogelijk [zie @foster2020].
De techniek die @foster2020 beschrijft veronderstelt echter raaien met een vaste lengte en locaties langsheen deze raaien op vaste afstanden van elkaar.
Het is niet duidelijk in hoeverre de methode toelaat om deze veronderstelling los te laten.
Bovendien werkt de aanpak niet met stratificatie, maar met variabele inclusiekansen.
De twee zijn echter aan elkaar gelinkt: je kan een kaart met een bepaalde stratificatie en allocatie van aantal locaties per stratum omzetten naar een kaart met variabele inclusiekansen.
Deze inclusiekansen worden berekend op niveau van een verrasterde kaart, dus voor elke rastercel (= mogelijke locatie om te bemonsteren) is er een inclusiekans.
De methode gaat vervolgens op basis van informatie over de lengte en toegelaten richting van de raaien en een correctie voor randeffecten, geaggregeerde inclusiekansen berekenen voor de raaien zelf.
We kunnen dan als volgt de trekking uitvoeren:

-   Hoogteligging gebruiken om de richting van transecten te bepalen: enkel volgens toenemende hoogte (dit is dus een randvoorwaarde die je oplegt).
    Door deze randvoorwaarde is het niet meer nodig om ecotoop te beschouwen bij de berekening van inclusiekansen.

-   Een geschikte raailengte bepalen en tussenafstand tussen locaties binnen een raai (indien dit afhankelijk is van KRW zone, kan de hele procedure apart worden uitgevoerd per KRW zone).

-   De (variabele) inclusiekansen berekenen op basis van een verrasterde kaart(en) met de informatie die de inclusiekansen beïnvloedt (KRW zone, ecologische potentie).
    Deze inclusiekansen per rastercel omrekenen naar geaggregeerde inclusiekansen voor de raaien.

-   De trekking van raaien uitvoeren (deze methode leent zich meer tot permanente opvolging van dezelfde set van raaien/locaties, alhoewel gelijkaardige schema's zoals hierboven geschetst hier ook mogelijk zijn)

## Implementatie nieuw steekproefontwerp

De implementatie van een nieuw steekproefontwerp vraagt niet alleen een inspanning van de veldwerkers en de data-gebruikers, het kan ook de vergelijkbaarheid van de nieuwe data met de oude in het gedrang brengen.
Indien trends over de tijd geanalyseerd worden, is het belangrijk om voorzichtig om te springen met data die niet volgens hetzelfde protocol verzameld werd.

Indien men, zoals eerder gesuggereerd, zou overwegen om het hard substraat minder of niet meer te bemonsteren, is het belangrijk om te weten wat de echte bijdrage van deze zone is aan de biomassa MZB.
Het is aangeraden om binnen hard substraat minstens één jaar het protocol strikter toe te passen en een random punt met breuksteen niet te verleggen naar een plaats nabij waar er toch wat slik ligt.
In de jaren nadien bekomt men de biomassa MZB in hard substraat door de oppervlakte hard substraat te vermenigvuldigen met de geschatte biomassa MZB per oppervlaktemaat (bekomen uit een striktere toepassing van de staalnames in hard substraat).
De oppervlakte hard substraat kan jaar na jaar veranderen maar men zou dezelfde schatting van biomassa MZB per oppervlaktemaat blijven hanteren.
Indien de biomassa MZB van hard substraat verwaarloosbaar wordt geacht, kan men ook beslissen om het hard substraat volledig buiten beschouwing te laten.

Indien er drastische wijzigingen aan de staalnames en/of de methoden in het labo worden doorgevoerd, plant men best een overgangsjaar waar de oude en nieuwe methode naast elkaar gebruikt worden.
Hiermee kan het effect van de nieuwwe methoden ingeschat worden en kan historische data gecorrigeerd worden om vergelijkbaar te zijn met toekomstige data.
Voorbeelden van zulke drastische wijzigingen zijn het gebruik van mengstalen, een verandering van het volume van de stalen, of het zeven van de stalen op de staalnamelocatie.

De huidige berekening van de totale biomassa MZB komt overeen met het gemiddelde uit de Horvitz-Thompson type schatters.
Deze methode heeft, praktisch gezien, dan ook een streepje voor op de andere schatters aangezien de historische data vergeleken kan worden met nieuwe berekeningen (inclusief schatting van de variantie).
Indien één van de andere schatters verkozen zou worden boven de Horvitz-Thompson schatter, is het aangeraden om, indien mogelijk, de schatters toe te passen op historische data om consistentie in tijdsreeksen te vrijwaren.

<!--chapter:end:04_discussie.Rmd-->


`r if (knitr::is_html_output()) {'# Bibliografie {-}'}`

<!--chapter:end:zzz_bibliografietitel.Rmd-->

